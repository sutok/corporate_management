# プロジェクト TODO リスト

**最終更新**: 2026-01-03 (Linux風権限管理システム完全実装完了)
**プロジェクト**: 営業日報システム (FastAPI + React)

---

## 📊 進捗サマリー

- **バックエンドAPI**: 11/11 ルーター実装済み ✅
- **Linux風権限管理システム**: 完全実装完了 ✅
  - データベース（5テーブル）✅
  - モデル（5ファイル）✅
  - 権限チェック機能 ✅
  - 初期データ（37権限、4グループ）✅
- **権限統合**: 完全統合（6/6 ルーター） ✅
  - branches, companies, customers, daily_reports, departments, users
- **テスト**: 全テスト通過（34/34 passing） ✅
- **コード品質**: SQLAlchemy 2.0 + Pydantic v2 対応完了 ✅
- **フロントエンド**: 基本画面実装完了（4画面） ✅

---

## ✅ 完了済みタスク

### バックエンド実装
- [x] JWT認証システム (auth.py)
- [x] 企業管理API (companies.py)
- [x] 支店管理API (branches.py)
- [x] 部署管理API (departments.py)
- [x] ユーザー管理API (users.py)
- [x] 顧客管理API (customers.py)
- [x] 日報管理API (daily_reports.py)
- [x] 施設管理API (facilities.py) - 後に削除
- [x] 施設所属管理API (facility_assignments.py) - 後に削除
- [x] サービス契約管理API (subscriptions.py)
- [x] **Linux風権限管理システム完全実装** (2026-01-03)
  - [x] データベース設計（5テーブル）
  - [x] マイグレーション作成・適用
  - [x] SQLAlchemyモデル（5ファイル）
  - [x] 権限チェック機能 (app/auth/permissions.py)
  - [x] 使用例ルーター (app/routers/permissions_example.py)
  - [x] 初期データ投入スクリプト (scripts/seed_permissions.py)
  - [x] 設計ドキュメント (claudedocs/権限管理.md)

### テスト
- [x] 全APIルーターのテスト実装 (9ファイル - 施設関連削除後)
- [x] Subscriptions APIテスト (test_subscriptions.py - 8テストケース)
- [x] Service Subscription History テスト (4テストケース追加)
- [x] テスト実行確認 (全テスト成功 - 34/34 passing)
- [x] 権限管理システムの基本テスト (既存テストに権限割り当てを追加)
- [ ] 権限チェックの詳細テスト（401/403テストケース）- 未実装

### データベース
- [x] スキーマ設計とマイグレーション
- [x] **Linux風権限管理システムテーブル実装** (2026-01-03)
  - [x] roles - 個別権限一覧（37権限）
  - [x] group_roles - グループ一覧（4システムグループ）
  - [x] group_role_permissions - グループ⇔権限の関連（72件）
  - [x] user_role_assignments - ユーザー⇔個別権限の割り当て
  - [x] user_group_assignments - ユーザー⇔グループの所属
- [x] 権限・グループ初期データ投入（37権限、4グループ）

### フロントエンド
- [x] Vite + React + TypeScript プロジェクト作成
- [x] 基本的なディレクトリ構造設定
- [x] 環境変数設定 (.env)
- [x] APIクライアント設定 (axios + dailyReports + users)
- [x] ルーティング設定 (React Router)
- [x] 認証コンテキスト実装
- [x] ビルド・開発サーバー動作確認
- [x] 共通レイアウトコンポーネント (Layout)
- [x] ログイン画面
- [x] ダッシュボード（ユーザー情報 + 最近の日報表示）
- [x] 日報一覧・作成画面（CRUD機能）
- [x] ユーザー管理画面（管理者用・CRUD機能）

### コード品質・保守性
- [x] **SQLAlchemy 2.0互換性対応** (2026-01-03)
  - [x] declarative_base import パス修正 (database.py)
- [x] **Pydantic v2マイグレーション** (2026-01-03)
  - [x] ConfigDict 方式への移行 (6 schema files)
  - [x] SettingsConfigDict 適用 (config.py)
- [x] **権限システムドキュメント作成** (2026-01-03)
  - [x] 権限適用例ドキュメント (branches_権限適用例.md)
  - [x] 権限割り当て戦略ドキュメント (権限割り当て戦略.md)

---

## ❌ 未完了タスク

### 🔴 高優先度 (セキュリティ & 基盤)

#### 1. 既存ルーターへの権限チェック適用 ✅ **完了**
**説明**: 全ての主要ルーターに権限チェックを実装しました（2026-01-03）

**対象ルーター**:
- [ ] auth.py - 認証関連（権限チェック不要）
- [x] branches.py - 支店管理 ✅
- [x] companies.py - 企業管理 ✅
- [x] customers.py - 顧客管理 ✅
- [x] daily_reports.py - 日報管理 ✅（動的スコープ対応）
- [x] departments.py - 部署管理 ✅
- [ ] facilities.py - 施設管理（削除済み）
- [ ] facility_assignments.py - 施設所属管理（削除済み）
- [x] users.py - ユーザー管理 ✅（自己更新対応）

**実装内容**:
- Pattern 1（Basic CRUD）: branches.py, departments.py, companies.py
- Pattern 2（自己操作許可）: users.py, customers.py
- Pattern 3（動的スコープ）: daily_reports.py（view_all/view_self）

**実装日**: 2026-01-03
**実績工数**: 約6時間（実装 + テスト修正 + PR作成・マージ）
**PR**: #8
**追加作業**:
- 全34テストの権限割り当て対応
- SQLAlchemy 2.0互換性修正
- Pydantic v2マイグレーション（6ファイル）
- 権限適用例ドキュメント作成（2ファイル）

---

#### 2. フロントエンド環境セットアップ ✅ **完了**
**説明**: React + TypeScript + Vite プロジェクトの初期構築

**タスク**:
- [x] Vite + React + TypeScript プロジェクト作成
- [x] 基本的なディレクトリ構造設定
- [x] 環境変数設定 (.env)
- [x] APIクライアント設定 (axios)
- [x] ルーティング設定 (React Router)
- [x] 認証コンテキスト実装
- [x] ビルド・開発サーバー動作確認

**実装内容**:
- React 18 + TypeScript + Vite プロジェクト構築
- 認証機能付きルーティング (ProtectedRoute, PublicRoute)
- Axios インターセプターによる JWT トークン自動付与
- AuthContext による認証状態管理
- ログイン、ダッシュボード、日報、ユーザー管理ページ作成
- 開発サーバー起動確認済み (http://localhost:5173)

**参考**: `frontend/README.md`

**実施日**: 2026-01-01

---

### 🟡 中優先度 (機能拡張)

#### 3. Service Subscription History 機能実装 ✅ **完了**
**説明**: 契約履歴の取得・表示機能

**場所**: `app/routers/subscriptions.py:47-104`

**実装内容**:
- [x] ServiceSubscriptionHistory モデル活用
- [x] 履歴取得エンドポイント実装
- [x] 履歴データの整形・返却
- [x] テストケース追加

**実装詳細**:
- GET `/api/subscriptions/history` エンドポイント実装
- オプションの `subscription_id` パラメータでフィルタリング
- 会社レベルのアクセス制御（他社データ防止）
- 新しい順にソート（changed_at DESC）
- 4つのテストケース追加（成功、フィルタ、アクセス制御、空データ）

**実施日**: 2026-01-01
**PR**: #4

---

#### 4. 権限チェック統合後のテスト拡充
**説明**: 既存テストに権限チェックのテストケースを追加

**タスク**:
- [ ] test_auth.py - 権限チェックテスト追加
- [ ] test_branches.py - 権限チェックテスト追加
- [ ] test_companies.py - 権限チェックテスト追加
- [ ] test_customers.py - 権限チェックテスト追加
- [ ] test_daily_reports.py - 権限チェックテスト追加
- [ ] test_departments.py - 権限チェックテスト追加
- [ ] test_facilities.py - 権限チェックテスト追加
- [ ] test_facility_assignments.py - 権限チェックテスト追加
- [ ] test_users.py - 権限チェックテスト追加

**各テストに追加すべき項目**:
- 認証なしでのアクセステスト (401 Unauthorized)
- 権限なしでのアクセステスト (403 Forbidden)
- 適切な権限を持つユーザーでのアクセステスト (200 OK)

**参考**: `tests/test_subscriptions.py:170-203`

**推定工数**: 6-8時間

---

#### 5. フロントエンド基本画面実装 ✅ **完了**
**説明**: 主要画面のUI実装

**優先実装画面**:
- [x] ログイン画面
- [x] ダッシュボード
- [x] 日報一覧・作成画面
- [x] ユーザー管理画面（管理者用）

**実装内容**:
- 共通Layoutコンポーネント（ナビゲーション、ヘッダー、ユーザーメニュー）
- ログインページ（既存を維持）
- ダッシュボード（ユーザー情報 + 最近の日報5件表示）
- 日報管理ページ（一覧表示、新規作成フォーム、削除機能）
- ユーザー管理ページ（一覧表示、新規作成フォーム、削除機能、権限チェック）
- レスポンシブデザイン対応
- エラーハンドリング実装

**実施日**: 2026-01-01

---

### 🟢 低優先度 (品質向上・最適化)

#### 6. APIドキュメント更新
**タスク**:
- [ ] Permission & Role システムのAPI仕様追加
- [ ] Swagger/OpenAPI ドキュメント充実
- [ ] 各エンドポイントの権限要件を明記
- [ ] レスポンススキーマの詳細化

**場所**: `claudedocs/API設計書.md`

**推定工数**: 2-3時間

---

#### 7. エラーハンドリング強化
**タスク**:
- [ ] カスタムエラーレスポンスの統一
- [ ] 詳細なエラーメッセージ
- [ ] ロギング強化
- [ ] エラー監視設定

**推定工数**: 3-4時間

---

#### 8. パフォーマンス最適化
**タスク**:
- [ ] データベースクエリの最適化
- [ ] N+1問題の解消
- [ ] キャッシング戦略の実装
- [ ] ページネーション実装
- [ ] インデックス最適化

**推定工数**: 4-6時間

---

#### 9. CI/CD パイプライン構築
**タスク**:
- [ ] GitHub Actions 設定
- [ ] 自動テスト実行
- [ ] リンター・フォーマッター統合
- [ ] デプロイ自動化

**推定工数**: 4-6時間

---

#### 10. セキュリティ強化
**タスク**:
- [ ] CORS設定の厳格化
- [ ] レート制限実装
- [ ] CSRFトークン実装
- [ ] セキュリティヘッダー設定
- [ ] 依存関係の脆弱性スキャン

**推定工数**: 3-4時間

---

## 📋 推奨作業順序

### Phase 1: セキュリティ基盤 (優先度: 🔴) ✅ **一部完了**
1. ✅ 既存ルーターへの権限チェック適用 (実績: 6h)
2. ⚠️ 権限チェック統合後のテスト拡充 (6-8h) - 基本テストは完了、詳細テスト（401/403）は未実装

**合計**: 10-14時間（進捗: 6/14時間 = 43%完了）

---

### Phase 2: フロントエンド基盤 (優先度: 🔴) ✅ **完了**
1. ✅ フロントエンド環境セットアップ (実績: 3-4h)
2. ✅ ログイン画面実装 (実績: 2-4h)
3. ✅ ダッシュボード実装 (実績: 3-4h)

**合計**: 8-12時間（進捗: 100%完了）
**実施日**: 2026-01-01

---

### Phase 3: 機能拡張 (優先度: 🟡) ✅ **完了**
1. ✅ Service Subscription History 実装 (実績: 2-3h)
2. ✅ 日報画面実装 (実績: 3-4h)
3. ✅ ユーザー管理画面実装 (実績: 3-4h)

**合計**: 8-11時間（進捗: 100%完了）
**実施日**: 2026-01-01

---

### Phase 4: 品質向上 (優先度: 🟢) ⚠️ **一部完了**
1. ⚠️ APIドキュメント更新 (2-3h) - 権限システムドキュメントは作成済み、API設計書は未更新
2. ⚠️ エラーハンドリング強化 (3-4h) - 未実装
3. ⚠️ パフォーマンス最適化 (4-6h) - 未実装
4. ✅ 非推奨APIの更新 (実績: 1h)
   - SQLAlchemy 2.0互換性修正
   - Pydantic v2マイグレーション

**合計**: 9-13時間（進捗: 1/13時間 = 8%完了）

---

## 📌 メモ

### 技術的な注意事項
- **Linux風権限管理システム** (2026-01-03実装)
  - 権限コード一覧: `backend/scripts/seed_permissions.py` 参照
  - 権限チェック関数: `app/auth/permissions.py` 参照
  - 使用例: `app/routers/permissions_example.py` 参照
  - 設計仕様: `claudedocs/権限管理.md` 参照
- 既存の権限チェック実装例は `app/routers/subscriptions.py` を参照
- テストデータ作成のヘルパー関数は `tests/test_subscriptions.py:create_test_data()` を参照

### 未コミット変更
- `.claude/settings.local.json` - ローカル設定（必要に応じてコミット）
- `.gitallowed` - git-secrets 除外パターン（必要に応じてコミット）

---

## 🎯 次のアクション

**即座に取り組むべきタスク**:
1. ✅ ~~既存ルーターへの権限チェック適用（セキュリティクリティカル）~~ - 完了
2. ✅ ~~フロントエンド環境セットアップ（開発開始に必要）~~ - 完了
3. 🔄 権限チェックの詳細テストケース追加（401/403テスト）
4. 🔄 フロントエンド機能拡張（残り画面実装）
   - 企業管理画面
   - 支店管理画面
   - 部署管理画面
   - 顧客管理画面
   - 権限管理画面（管理者用）

**チームで相談が必要な項目**:
- フロントエンドのUIフレームワーク選定（Material-UI, Ant Design, etc.）
- デプロイ環境の決定（AWS, GCP, Azure）
- CI/CDパイプライン構築の優先度

---

**作成日**: 2026-01-01
**作成者**: Claude Code
**バージョン**: 1.0.0
