# æ¨©é™å‰²ã‚Šå½“ã¦æˆ¦ç•¥

**ä½œæˆæ—¥**: 2026-01-03
**ç›®çš„**: æ—¢å­˜APIãƒ«ãƒ¼ã‚¿ãƒ¼ã¸ã®æ¨©é™ã‚·ã‚¹ãƒ†ãƒ çµ±åˆã®æœ€é©ãªæ–¹æ³•ã‚’å®šç¾©

---

## ğŸ“‹ ç¾çŠ¶åˆ†æ

### å•é¡Œç‚¹
1. **ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ­ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯**: `current_user.role not in ["admin", "manager"]`
2. **æ¨©é™ãƒã‚§ãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯ã®æ•£åœ¨**: å„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å€‹åˆ¥å®Ÿè£…
3. **è‡ªåˆ†è‡ªèº«ã®æ“ä½œã®ç‰¹åˆ¥å‡¦ç†**: update/deleteã§è¤‡é›‘ãªæ¡ä»¶åˆ†å²
4. **ä¿å®ˆæ€§ã®ä½ä¸‹**: æ¨©é™å¤‰æ›´æ™‚ã«è¤‡æ•°ç®‡æ‰€ã®ä¿®æ­£ãŒå¿…è¦

### æ—¢å­˜ã®æ¨©é™å®šç¾©ï¼ˆ37ä»¶ï¼‰
- **user**: 6ä»¶ï¼ˆview, view_self, create, update, update_self, deleteï¼‰
- **report**: 10ä»¶ï¼ˆview, view_all, view_self, create, update, update_self, delete, delete_self, approve, commentï¼‰
- **customer**: 5ä»¶ï¼ˆview, view_assigned, create, update, deleteï¼‰
- **company**: 2ä»¶ï¼ˆview, updateï¼‰
- **branch**: 4ä»¶ï¼ˆview, create, update, deleteï¼‰
- **department**: 4ä»¶ï¼ˆview, create, update, deleteï¼‰
- **permission**: 4ä»¶ï¼ˆview, assign, revoke, manage_groupsï¼‰
- **admin**: 2ä»¶ï¼ˆaccess, system_settingsï¼‰

---

## ğŸ¯ æ¨å¥¨ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

### ãƒ‘ã‚¿ãƒ¼ãƒ³1: åŸºæœ¬çš„ãªCRUDæ¨©é™ï¼ˆæ¨å¥¨ï¼‰

**é©ç”¨å¯¾è±¡**: users, branches, departments, companies, customers

```python
from app.auth.permissions import require_permission, require_any_permission

@router.get("")
async def list_resources(
    current_user: User = Depends(require_permission("resource.view")),
    db: AsyncSession = Depends(get_db),
):
    """ä¸€è¦§å–å¾— - resource.viewæ¨©é™ãŒå¿…è¦"""
    ...

@router.get("/{id}")
async def get_resource(
    id: int,
    current_user: User = Depends(require_permission("resource.view")),
    db: AsyncSession = Depends(get_db),
):
    """è©³ç´°å–å¾— - resource.viewæ¨©é™ãŒå¿…è¦"""
    ...

@router.post("")
async def create_resource(
    data: ResourceCreate,
    current_user: User = Depends(require_permission("resource.create")),
    db: AsyncSession = Depends(get_db),
):
    """ä½œæˆ - resource.createæ¨©é™ãŒå¿…è¦"""
    ...

@router.put("/{id}")
async def update_resource(
    id: int,
    data: ResourceUpdate,
    current_user: User = Depends(require_permission("resource.update")),
    db: AsyncSession = Depends(get_db),
):
    """æ›´æ–° - resource.updateæ¨©é™ãŒå¿…è¦"""
    ...

@router.delete("/{id}")
async def delete_resource(
    id: int,
    current_user: User = Depends(require_permission("resource.delete")),
    db: AsyncSession = Depends(get_db),
):
    """å‰Šé™¤ - resource.deleteæ¨©é™ãŒå¿…è¦"""
    ...
```

**åˆ©ç‚¹**:
- ã‚·ãƒ³ãƒ—ãƒ«ã§ä¸€è²«æ€§ãŒã‚ã‚‹
- å„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å¿…è¦æ¨©é™ãŒæ˜ç¢º
- ä¿å®ˆæ€§ãŒé«˜ã„

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³2: è‡ªåˆ†è‡ªèº«ã®æ“ä½œã‚’è¨±å¯ï¼ˆuser, reportãªã©ï¼‰

**é©ç”¨å¯¾è±¡**: users, daily_reports

```python
from app.auth.permissions import require_any_permission, check_permission

@router.get("/me")
async def get_my_profile(
    current_user: User = Depends(require_permission("user.view_self")),
    db: AsyncSession = Depends(get_db),
):
    """è‡ªåˆ†ã®æƒ…å ±å–å¾— - user.view_selfæ¨©é™ãŒå¿…è¦"""
    return current_user

@router.put("/me")
async def update_my_profile(
    data: UserUpdate,
    current_user: User = Depends(require_permission("user.update_self")),
    db: AsyncSession = Depends(get_db),
):
    """è‡ªåˆ†ã®æƒ…å ±æ›´æ–° - user.update_selfæ¨©é™ãŒå¿…è¦"""
    ...

@router.put("/{user_id}")
async def update_user(
    user_id: int,
    data: UserUpdate,
    current_user: User = Depends(require_any_permission(["user.update", "user.update_self"])),
    db: AsyncSession = Depends(get_db),
):
    """
    ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–° - ä»¥ä¸‹ã®ã„ãšã‚Œã‹:
    - user.updateæ¨©é™ï¼ˆä»–äººã‚‚æ›´æ–°å¯èƒ½ï¼‰
    - user.update_selfæ¨©é™ï¼ˆè‡ªåˆ†ã®ã¿ï¼‰
    """
    # è‡ªåˆ†ã®æ›´æ–°ã®å ´åˆã¯user.update_selfæ¨©é™ã§OK
    if user_id == current_user.id:
        return  # user.update_selfã§è¨±å¯æ¸ˆã¿

    # ä»–äººã®æ›´æ–°ã®å ´åˆã¯user.updateæ¨©é™ãŒå¿…è¦
    has_update_permission = await check_permission(db, current_user.id, "user.update")
    if not has_update_permission:
        raise HTTPException(
            status_code=403,
            detail="ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ›´æ–°ã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“"
        )
    ...
```

**åˆ©ç‚¹**:
- è‡ªåˆ†è‡ªèº«ã®æ“ä½œã¨ä»–äººã®æ“ä½œã‚’æ˜ç¢ºã«åˆ†é›¢
- ã‚ˆã‚Šç´°ã‹ã„æ¨©é™åˆ¶å¾¡ãŒå¯èƒ½

**æ¬ ç‚¹**:
- ã‚„ã‚„è¤‡é›‘ã«ãªã‚‹

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³3: è¤‡æ•°æ¨©é™ã®çµ„ã¿åˆã‚ã›ï¼ˆreport.viewç³»ï¼‰

**é©ç”¨å¯¾è±¡**: daily_reports

```python
@router.get("")
async def list_reports(
    current_user: User = Depends(require_any_permission(["report.view_all", "report.view_self"])),
    db: AsyncSession = Depends(get_db),
):
    """
    æ—¥å ±ä¸€è¦§å–å¾— - ä»¥ä¸‹ã®ã„ãšã‚Œã‹:
    - report.view_allæ¨©é™ï¼ˆå…¨æ—¥å ±ï¼‰
    - report.view_selfæ¨©é™ï¼ˆè‡ªåˆ†ã®æ—¥å ±ã®ã¿ï¼‰
    """
    # å…¨æ—¥å ±é–²è¦§æ¨©é™ãŒã‚ã‚‹ã‹ç¢ºèª
    has_view_all = await check_permission(db, current_user.id, "report.view_all")

    if has_view_all:
        # å…¨æ—¥å ±ã‚’å–å¾—
        query = select(DailyReport).where(DailyReport.company_id == current_user.company_id)
    else:
        # è‡ªåˆ†ã®æ—¥å ±ã®ã¿å–å¾—
        query = select(DailyReport).where(
            DailyReport.company_id == current_user.company_id,
            DailyReport.user_id == current_user.id
        )

    result = await db.execute(query)
    return result.scalars().all()
```

**åˆ©ç‚¹**:
- ãƒ‡ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ—ã‚’æ¨©é™ã«å¿œã˜ã¦å‹•çš„ã«å¤‰æ›´
- æŸ”è»Ÿæ€§ãŒé«˜ã„

---

## ğŸ“Š å„ãƒ«ãƒ¼ã‚¿ãƒ¼ã¸ã®ãƒãƒƒãƒ”ãƒ³ã‚°

### 1. users.pyï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ï¼‰

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ãƒ¡ã‚½ãƒƒãƒ‰ | å¿…è¦ãªæ¨©é™ | å‚™è€ƒ |
|--------------|---------|-----------|------|
| `/api/users` | GET | `user.view` | åŒã˜ä¼æ¥­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ |
| `/api/users/me` | GET | `user.view_self` | è‡ªåˆ†ã®æƒ…å ±å–å¾—ï¼ˆè¿½åŠ æ¨å¥¨ï¼‰ |
| `/api/users/{id}` | GET | `user.view` OR `user.view_self` | IDãŒè‡ªåˆ†ãªã‚‰_selfã§OK |
| `/api/users` | POST | `user.create` | ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ |
| `/api/users/me` | PUT | `user.update_self` | è‡ªåˆ†ã®æƒ…å ±æ›´æ–°ï¼ˆè¿½åŠ æ¨å¥¨ï¼‰ |
| `/api/users/{id}` | PUT | `user.update` OR `user.update_self` | IDãŒè‡ªåˆ†ãªã‚‰_selfã§OK |
| `/api/users/{id}` | DELETE | `user.delete` | ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ |

### 2. daily_reports.pyï¼ˆæ—¥å ±ç®¡ç†ï¼‰

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ãƒ¡ã‚½ãƒƒãƒ‰ | å¿…è¦ãªæ¨©é™ | å‚™è€ƒ |
|--------------|---------|-----------|------|
| `/api/daily-reports` | GET | `report.view_all` OR `report.view_self` | æ¨©é™ã«å¿œã˜ã¦ã‚¹ã‚³ãƒ¼ãƒ—å¤‰æ›´ |
| `/api/daily-reports/{id}` | GET | `report.view_all` OR `report.view_self` | è‡ªåˆ†ã®æ—¥å ±ã‹ç¢ºèª |
| `/api/daily-reports` | POST | `report.create` | æ—¥å ±ä½œæˆ |
| `/api/daily-reports/{id}` | PUT | `report.update` OR `report.update_self` | è‡ªåˆ†ã®æ—¥å ±ã‹ç¢ºèª |
| `/api/daily-reports/{id}` | DELETE | `report.delete` OR `report.delete_self` | è‡ªåˆ†ã®æ—¥å ±ã‹ç¢ºèª |
| `/api/daily-reports/{id}/approve` | POST | `report.approve` | æ—¥å ±æ‰¿èªï¼ˆè¿½åŠ æ¨å¥¨ï¼‰ |
| `/api/daily-reports/{id}/comments` | POST | `report.comment` | ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ ï¼ˆè¿½åŠ æ¨å¥¨ï¼‰ |

### 3. customers.pyï¼ˆé¡§å®¢ç®¡ç†ï¼‰

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ãƒ¡ã‚½ãƒƒãƒ‰ | å¿…è¦ãªæ¨©é™ | å‚™è€ƒ |
|--------------|---------|-----------|------|
| `/api/customers` | GET | `customer.view` OR `customer.view_assigned` | æ¨©é™ã«å¿œã˜ã¦ã‚¹ã‚³ãƒ¼ãƒ—å¤‰æ›´ |
| `/api/customers/{id}` | GET | `customer.view` OR `customer.view_assigned` | æ‹…å½“é¡§å®¢ã‹ç¢ºèª |
| `/api/customers` | POST | `customer.create` | é¡§å®¢ä½œæˆ |
| `/api/customers/{id}` | PUT | `customer.update` | é¡§å®¢æ›´æ–° |
| `/api/customers/{id}` | DELETE | `customer.delete` | é¡§å®¢å‰Šé™¤ |

### 4. companies.pyï¼ˆä¼æ¥­ç®¡ç†ï¼‰

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ãƒ¡ã‚½ãƒƒãƒ‰ | å¿…è¦ãªæ¨©é™ | å‚™è€ƒ |
|--------------|---------|-----------|------|
| `/api/companies/me` | GET | `company.view` | è‡ªç¤¾æƒ…å ±å–å¾— |
| `/api/companies/me` | PUT | `company.update` | è‡ªç¤¾æƒ…å ±æ›´æ–° |

### 5. branches.pyï¼ˆæ”¯åº—ç®¡ç†ï¼‰

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ãƒ¡ã‚½ãƒƒãƒ‰ | å¿…è¦ãªæ¨©é™ | å‚™è€ƒ |
|--------------|---------|-----------|------|
| `/api/branches` | GET | `branch.view` | æ”¯åº—ä¸€è¦§ |
| `/api/branches/{id}` | GET | `branch.view` | æ”¯åº—è©³ç´° |
| `/api/branches` | POST | `branch.create` | æ”¯åº—ä½œæˆ |
| `/api/branches/{id}` | PUT | `branch.update` | æ”¯åº—æ›´æ–° |
| `/api/branches/{id}` | DELETE | `branch.delete` | æ”¯åº—å‰Šé™¤ |

### 6. departments.pyï¼ˆéƒ¨ç½²ç®¡ç†ï¼‰

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ãƒ¡ã‚½ãƒƒãƒ‰ | å¿…è¦ãªæ¨©é™ | å‚™è€ƒ |
|--------------|---------|-----------|------|
| `/api/departments` | GET | `department.view` | éƒ¨ç½²ä¸€è¦§ |
| `/api/departments/{id}` | GET | `department.view` | éƒ¨ç½²è©³ç´° |
| `/api/departments` | POST | `department.create` | éƒ¨ç½²ä½œæˆ |
| `/api/departments/{id}` | PUT | `department.update` | éƒ¨ç½²æ›´æ–° |
| `/api/departments/{id}` | DELETE | `department.delete` | éƒ¨ç½²å‰Šé™¤ |

### 7. subscriptions.pyï¼ˆã‚µãƒ¼ãƒ“ã‚¹å¥‘ç´„ç®¡ç†ï¼‰

æ—¢ã«æ¨©é™ãƒã‚§ãƒƒã‚¯å®Ÿè£…æ¸ˆã¿ âœ…

---

## ğŸš€ å®Ÿè£…ã®å„ªå…ˆé †ä½

### Phase 1: åŸºæœ¬çš„ãªCRUDï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãªã‚‚ã®ï¼‰
1. **branches.py** - ã‚·ãƒ³ãƒ—ãƒ«ãªCRUD
2. **departments.py** - ã‚·ãƒ³ãƒ—ãƒ«ãªCRUD
3. **companies.py** - 2ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ã¿

**æ¨å®šæ™‚é–“**: 2-3æ™‚é–“

### Phase 2: è‡ªåˆ†è‡ªèº«ã®æ“ä½œã‚’å«ã‚€ã‚‚ã®
4. **users.py** - user.update_self ã®å®Ÿè£…
5. **customers.py** - customer.view_assigned ã®å®Ÿè£…

**æ¨å®šæ™‚é–“**: 2-3æ™‚é–“

### Phase 3: è¤‡é›‘ãªã‚¹ã‚³ãƒ¼ãƒ—åˆ¶å¾¡
6. **daily_reports.py** - view_all/view_self ã®å‹•çš„ã‚¹ã‚³ãƒ¼ãƒ—

**æ¨å®šæ™‚é–“**: 2-3æ™‚é–“

---

## ğŸ’¡ å®Ÿè£…æ™‚ã®æ³¨æ„ç‚¹

### 1. ä¼æ¥­ãƒ¬ãƒ™ãƒ«ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’ç¶­æŒ
æ¨©é™ãƒã‚§ãƒƒã‚¯ã ã‘ã§ãªãã€åŒã˜ä¼æ¥­ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ã™ã‚‹ï¼š

```python
# å¿…ãšä¼æ¥­IDã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
query = select(Resource).where(
    Resource.company_id == current_user.company_id
)
```

### 2. è‡ªåˆ†è‡ªèº«ã®æ“ä½œã®æœ€é©åŒ–
`/me` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦æ˜ç¤ºçš„ã«åˆ†é›¢ï¼š

```python
# æ¨å¥¨
@router.get("/me")
async def get_my_profile(
    current_user: User = Depends(require_permission("user.view_self")),
):
    return current_user

# éæ¨å¥¨ï¼ˆè¤‡é›‘ã«ãªã‚‹ï¼‰
@router.get("/{user_id}")
async def get_user(user_id: int, ...):
    if user_id == current_user.id:
        # è‡ªåˆ†ã®å ´åˆ
    else:
        # ä»–äººã®å ´åˆ
```

### 3. æ—¢å­˜ã®ãƒ­ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯ã‚’æ®µéšçš„ã«ç½®ãæ›ãˆ
ä¸€åº¦ã«å…¨ã¦æ›¸ãæ›ãˆã‚‹ã®ã§ã¯ãªãã€ãƒ«ãƒ¼ã‚¿ãƒ¼å˜ä½ã§ç§»è¡Œï¼š

```python
# æ—§
if current_user.role not in ["admin", "manager"]:
    raise HTTPException(403, "æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“")

# æ–°
current_user: User = Depends(require_permission("resource.create"))
```

### 4. ãƒ†ã‚¹ãƒˆã®è¿½åŠ 
å„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¯¾ã—ã¦ï¼š
- âœ… èªè¨¼ãªã—ã§ã‚¢ã‚¯ã‚»ã‚¹ â†’ 401
- âœ… æ¨©é™ãªã—ã§ã‚¢ã‚¯ã‚»ã‚¹ â†’ 403
- âœ… é©åˆ‡ãªæ¨©é™ã§ã‚¢ã‚¯ã‚»ã‚¹ â†’ 200/201

---

## ğŸ“ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

1. **ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ãƒ¬ãƒ“ãƒ¥ãƒ¼** - æˆ¦ç•¥ã«åŒæ„ã™ã‚‹ã‹ç¢ºèª
2. **Phase 1ã‹ã‚‰å®Ÿè£…é–‹å§‹** - branches.py ã‹ã‚‰é–‹å§‹
3. **ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹è¿½åŠ ** - å„ãƒ«ãƒ¼ã‚¿ãƒ¼ã«æ¨©é™ãƒã‚§ãƒƒã‚¯ã®ãƒ†ã‚¹ãƒˆè¿½åŠ 
4. **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°** - APIè¨­è¨ˆæ›¸ã«æ¨©é™è¦ä»¶ã‚’è¿½è¨˜

---

**è³ªå•ãƒ»ç›¸è«‡äº‹é …**:
- ã“ã®æˆ¦ç•¥ã§å•é¡Œãªã„ã‹ï¼Ÿ
- å„ªå…ˆé †ä½ã‚’å¤‰æ›´ã—ãŸã„ãƒ«ãƒ¼ã‚¿ãƒ¼ã¯ã‚ã‚‹ã‹ï¼Ÿ
- è¿½åŠ ã§å®Ÿè£…ã™ã¹ãæ¨©é™ã¯ã‚ã‚‹ã‹ï¼Ÿ
