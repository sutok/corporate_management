# æ¨©é™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  è‰æ¡ˆ

**ä½œæˆæ—¥**: 2026-01-03
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0 (è‰æ¡ˆ)
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: è¨­è¨ˆæ¤œè¨ä¸­

---

## ğŸ“– ç›®æ¬¡

1. [ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦](#ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦)
2. [ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ](#ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ)
3. [ERå›³](#erå›³)
4. [æ¨©é™ãƒã‚§ãƒƒã‚¯ãƒ•ãƒ­ãƒ¼](#æ¨©é™ãƒã‚§ãƒƒã‚¯ãƒ•ãƒ­ãƒ¼)
5. [ä½¿ç”¨ä¾‹](#ä½¿ç”¨ä¾‹)
6. [å®Ÿè£…ä¾‹](#å®Ÿè£…ä¾‹)

---

## ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

Linuxé¢¨ã®æ¨©é™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚

### åŸºæœ¬ã‚³ãƒ³ã‚»ãƒ—ãƒˆ

**å€‹åˆ¥æ¨©é™ + ã‚°ãƒ«ãƒ¼ãƒ—æ¨©é™**

- **å€‹åˆ¥æ¨©é™ (roles)**: å€‹ã€…ã®æ“ä½œæ¨©é™ï¼ˆä¾‹: "user.create", "report.view"ï¼‰
- **ã‚°ãƒ«ãƒ¼ãƒ—æ¨©é™ (group_roles)**: è¤‡æ•°ã®å€‹åˆ¥æ¨©é™ã‚’ã¾ã¨ã‚ãŸã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆä¾‹: "admin", "manager"ï¼‰
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®ä»˜ä¸**:
  - ç›´æ¥å€‹åˆ¥æ¨©é™ã‚’ä»˜ä¸ (user_role_assignments)
  - ã‚°ãƒ«ãƒ¼ãƒ—ã«æ‰€å±ã•ã›ã‚‹ (group_role_assignments)

### Linux ã¨ã®å¯¾å¿œ

| Linux | æœ¬ã‚·ã‚¹ãƒ†ãƒ  |
|-------|-----------|
| ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™ (r, w, x) | rolesï¼ˆå€‹åˆ¥æ¨©é™ï¼‰ |
| ã‚°ãƒ«ãƒ¼ãƒ— (admin, users) | group_rolesï¼ˆã‚°ãƒ«ãƒ¼ãƒ—æ¨©é™ï¼‰ |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ | user_role_assignmentsï¼ˆå€‹åˆ¥æ¨©é™å‰²ã‚Šå½“ã¦ï¼‰ |
| ã‚°ãƒ«ãƒ¼ãƒ—æ‰€å± | group_role_assignmentsï¼ˆã‚°ãƒ«ãƒ¼ãƒ—æ‰€å±ï¼‰ |

### æ¨©é™è¨ˆç®—å¼

```
æœ€çµ‚æ¨©é™ = å€‹åˆ¥æ¨©é™ âˆª ã‚°ãƒ«ãƒ¼ãƒ—æ¨©é™
```

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŒã¤æœ€çµ‚çš„ãªæ¨©é™ã¯ã€ç›´æ¥ä»˜ä¸ã•ã‚ŒãŸå€‹åˆ¥æ¨©é™ã¨ã‚°ãƒ«ãƒ¼ãƒ—çµŒç”±ã§å–å¾—ã—ãŸæ¨©é™ã®**å’Œé›†åˆï¼ˆUNIONï¼‰**ã¨ãªã‚Šã¾ã™ã€‚

---

## ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ

### 1. rolesï¼ˆå€‹åˆ¥æ¨©é™ä¸€è¦§ï¼‰

**ãƒ†ãƒ¼ãƒ–ãƒ«ã‚³ãƒ¡ãƒ³ãƒˆ**: `å€‹åˆ¥æ¨©é™ä¸€è¦§ï¼ˆã©ã‚“ãªæ¨©é™ãŒã‚ã‚‹ã‹ï¼‰`

å€‹ã€…ã®æ“ä½œæ¨©é™ã‚’å®šç¾©ã™ã‚‹ãƒã‚¹ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«

| ã‚«ãƒ©ãƒ å | å‹ | åˆ¶ç´„ | èª¬æ˜ | ä¾‹ |
|---------|-----|------|------|-----|
| `id` | Integer | PK | æ¨©é™ID | 1 |
| `code` | String(100) | UNIQUE, NOT NULL | æ¨©é™ã‚³ãƒ¼ãƒ‰ | `user.create` |
| `name` | String(255) | NOT NULL | æ¨©é™å | `ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ` |
| `description` | Text | NULLå¯ | æ¨©é™ã®èª¬æ˜ | `æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã™ã‚‹æ¨©é™` |
| `resource_type` | String(50) | NOT NULL | ãƒªã‚½ãƒ¼ã‚¹ç¨®åˆ¥ | `user` |
| `created_at` | DateTime | NOT NULL | ä½œæˆæ—¥æ™‚ | - |
| `updated_at` | DateTime | NOT NULL | æ›´æ–°æ—¥æ™‚ | - |

**ç‰¹å¾´:**
- `code`: ãƒ‰ãƒƒãƒˆåŒºåˆ‡ã‚Šã®éšå±¤çš„ãªå‘½åè¦å‰‡ï¼ˆ`{resource}.{action}`ï¼‰
- `resource_type`: ãƒªã‚½ãƒ¼ã‚¹ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–å¯èƒ½

**ä¾‹:**
```
user.view       - ãƒ¦ãƒ¼ã‚¶ãƒ¼é–²è¦§
user.create     - ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
user.update     - ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°
user.delete     - ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤
report.view     - ãƒ¬ãƒãƒ¼ãƒˆé–²è¦§
report.create   - ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
report.approve  - ãƒ¬ãƒãƒ¼ãƒˆæ‰¿èª
```

---

### 2. group_rolesï¼ˆã‚°ãƒ«ãƒ¼ãƒ—æ¨©é™ä¸€è¦§ï¼‰

**ãƒ†ãƒ¼ãƒ–ãƒ«ã‚³ãƒ¡ãƒ³ãƒˆ**: `ã‚°ãƒ«ãƒ¼ãƒ—ä¸€è¦§ï¼ˆã©ã‚“ãªã‚°ãƒ«ãƒ¼ãƒ—ãŒã‚ã‚‹ã‹ï¼‰`

è¤‡æ•°ã®å€‹åˆ¥æ¨©é™ã‚’ã¾ã¨ã‚ãŸã‚°ãƒ«ãƒ¼ãƒ—ã‚’å®šç¾©ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«

| ã‚«ãƒ©ãƒ å | å‹ | åˆ¶ç´„ | èª¬æ˜ | ä¾‹ |
|---------|-----|------|------|-----|
| `id` | Integer | PK | ã‚°ãƒ«ãƒ¼ãƒ—ID | 1 |
| `code` | String(100) | UNIQUE, NOT NULL | ã‚°ãƒ«ãƒ¼ãƒ—ã‚³ãƒ¼ãƒ‰ | `admin` |
| `name` | String(255) | NOT NULL | ã‚°ãƒ«ãƒ¼ãƒ—å | `ç®¡ç†è€…ã‚°ãƒ«ãƒ¼ãƒ—` |
| `description` | Text | NULLå¯ | ã‚°ãƒ«ãƒ¼ãƒ—ã®èª¬æ˜ | `ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ç”¨ã®ã‚°ãƒ«ãƒ¼ãƒ—` |
| `company_id` | Integer | FK, NULLå¯ | ä¼æ¥­ID | `NULL` or `123` |
| `is_system` | Boolean | NOT NULL, default: false | ã‚·ã‚¹ãƒ†ãƒ ã‚°ãƒ«ãƒ¼ãƒ—ã‹ | `true` |
| `created_at` | DateTime | NOT NULL | ä½œæˆæ—¥æ™‚ | - |
| `updated_at` | DateTime | NOT NULL | æ›´æ–°æ—¥æ™‚ | - |

**åˆ¶ç´„:**
- `company_id` ãŒ `NULL` ã®å ´åˆã¯ã‚·ã‚¹ãƒ†ãƒ ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆå…¨ä¼æ¥­å…±é€šï¼‰
- `company_id` ã«å€¤ãŒã‚ã‚‹å ´åˆã¯ä¼æ¥­å°‚ç”¨ã‚°ãƒ«ãƒ¼ãƒ—

**2ç¨®é¡ã®ã‚°ãƒ«ãƒ¼ãƒ—:**

| ç¨®é¡ | company_id | is_system | ç”¨é€” |
|------|-----------|-----------|------|
| **ã‚·ã‚¹ãƒ†ãƒ ã‚°ãƒ«ãƒ¼ãƒ—** | `NULL` | `true` | å…¨ä¼æ¥­å…±é€šã®æ¨™æº–ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆadmin, managerç­‰ï¼‰ |
| **ä¼æ¥­å°‚ç”¨ã‚°ãƒ«ãƒ¼ãƒ—** | ä¼æ¥­ID | `false` | å„ä¼æ¥­ãŒã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½ãªã‚°ãƒ«ãƒ¼ãƒ— |

---

### 3. group_role_permissionsï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ã«å«ã¾ã‚Œã‚‹æ¨©é™ï¼‰

**ãƒ†ãƒ¼ãƒ–ãƒ«ã‚³ãƒ¡ãƒ³ãƒˆ**: `ã‚°ãƒ«ãƒ¼ãƒ—ã«å«ã¾ã‚Œã‚‹æ¨©é™ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—â‡”æ¨©é™ï¼‰`

ã‚°ãƒ«ãƒ¼ãƒ—ã«å«ã¾ã‚Œã‚‹å€‹åˆ¥æ¨©é™ã®ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«

| ã‚«ãƒ©ãƒ å | å‹ | åˆ¶ç´„ | èª¬æ˜ |
|---------|-----|------|------|
| `id` | Integer | PK | ID |
| `group_role_id` | Integer | FK, NOT NULL | ã‚°ãƒ«ãƒ¼ãƒ—IDï¼ˆâ†’ group_roles.idï¼‰ |
| `role_id` | Integer | FK, NOT NULL | æ¨©é™IDï¼ˆâ†’ roles.idï¼‰ |
| `created_at` | DateTime | NOT NULL | ä½œæˆæ—¥æ™‚ |

**åˆ¶ç´„:**
- `UNIQUE(group_role_id, role_id)` - åŒã˜ã‚°ãƒ«ãƒ¼ãƒ—ã«åŒã˜æ¨©é™ã‚’é‡è¤‡è¿½åŠ ä¸å¯
- `ON DELETE CASCADE` - ã‚°ãƒ«ãƒ¼ãƒ—å‰Šé™¤æ™‚ã€ã“ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚‚å‰Šé™¤
- `ON DELETE CASCADE` - æ¨©é™å‰Šé™¤æ™‚ã€ã“ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚‚å‰Šé™¤

**å½¹å‰²:**
- ã‚°ãƒ«ãƒ¼ãƒ—ã¨å€‹åˆ¥æ¨©é™ã®å¤šå¯¾å¤šãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç®¡ç†
- ä¾‹: "admin"ã‚°ãƒ«ãƒ¼ãƒ—ã«ã¯ "user.create", "user.update", "user.delete" ãŒå«ã¾ã‚Œã‚‹

---

### 4. user_role_assignmentsï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å€‹åˆ¥æ¨©é™å‰²ã‚Šå½“ã¦ï¼‰

**ãƒ†ãƒ¼ãƒ–ãƒ«ã‚³ãƒ¡ãƒ³ãƒˆ**: `ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å€‹åˆ¥æ¨©é™å‰²ã‚Šå½“ã¦ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼â‡”æ¨©é™ï¼‰`

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç›´æ¥å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸå€‹åˆ¥æ¨©é™

| ã‚«ãƒ©ãƒ å | å‹ | åˆ¶ç´„ | èª¬æ˜ |
|---------|-----|------|------|
| `id` | Integer | PK | ID |
| `user_id` | Integer | FK, NOT NULL | ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆâ†’ users.idï¼‰ |
| `role_id` | Integer | FK, NOT NULL | æ¨©é™IDï¼ˆâ†’ roles.idï¼‰ |
| `granted_by` | Integer | FK, NULLå¯ | ä»˜ä¸è€…IDï¼ˆâ†’ users.idï¼‰ |
| `granted_at` | DateTime | NOT NULL | ä»˜ä¸æ—¥æ™‚ |
| `reason` | Text | NULLå¯ | ä»˜ä¸ç†ç”±ï¼ˆç›£æŸ»ç”¨ï¼‰ |
| `created_at` | DateTime | NOT NULL | ä½œæˆæ—¥æ™‚ |

**åˆ¶ç´„:**
- `UNIQUE(user_id, role_id)` - åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åŒã˜æ¨©é™ã‚’é‡è¤‡ä»˜ä¸ä¸å¯
- `ON DELETE CASCADE` - ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤æ™‚ã€ã“ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚‚å‰Šé™¤
- `ON DELETE CASCADE` - æ¨©é™å‰Šé™¤æ™‚ã€ã“ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚‚å‰Šé™¤

**ç›£æŸ»æ©Ÿèƒ½:**
- `granted_by`: èª°ãŒæ¨©é™ã‚’ä»˜ä¸ã—ãŸã‹
- `granted_at`: ã„ã¤æ¨©é™ãŒä»˜ä¸ã•ã‚ŒãŸã‹
- `reason`: ãªãœæ¨©é™ã‚’ä»˜ä¸ã—ãŸã‹ï¼ˆã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹å¯¾å¿œï¼‰

**ä½¿ç”¨ä¾‹:**
- ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä¸€æ™‚çš„ãªæ¨©é™ã‚’ä»˜ä¸
- ã‚°ãƒ«ãƒ¼ãƒ—ã«å«ã¾ã‚Œãªã„ç‰¹åˆ¥ãªæ¨©é™ã‚’ä»˜ä¸

---

### 5. user_group_assignmentsï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚°ãƒ«ãƒ¼ãƒ—æ‰€å±ï¼‰

**ãƒ†ãƒ¼ãƒ–ãƒ«ã‚³ãƒ¡ãƒ³ãƒˆ**: `ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚°ãƒ«ãƒ¼ãƒ—æ‰€å±ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼â‡”ã‚°ãƒ«ãƒ¼ãƒ—ï¼‰`

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰€å±ã™ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ç®¡ç†ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«

| ã‚«ãƒ©ãƒ å | å‹ | åˆ¶ç´„ | èª¬æ˜ |
|---------|-----|------|------|
| `id` | Integer | PK | ID |
| `user_id` | Integer | FK, NOT NULL | ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆâ†’ users.idï¼‰ |
| `group_role_id` | Integer | FK, NOT NULL | ã‚°ãƒ«ãƒ¼ãƒ—IDï¼ˆâ†’ group_roles.idï¼‰ |
| `assigned_by` | Integer | FK, NULLå¯ | å‰²ã‚Šå½“ã¦ãŸäººï¼ˆâ†’ users.idï¼‰ |
| `assigned_at` | DateTime | NOT NULL | å‰²ã‚Šå½“ã¦æ—¥æ™‚ |
| `created_at` | DateTime | NOT NULL | ä½œæˆæ—¥æ™‚ |

**åˆ¶ç´„:**
- `UNIQUE(user_id, group_role_id)` - åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åŒã˜ã‚°ãƒ«ãƒ¼ãƒ—ã«é‡è¤‡è¿½åŠ ä¸å¯
- `ON DELETE CASCADE` - ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤æ™‚ã€ã“ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚‚å‰Šé™¤
- `ON DELETE CASCADE` - ã‚°ãƒ«ãƒ¼ãƒ—å‰Šé™¤æ™‚ã€ã“ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚‚å‰Šé™¤

**ç›£æŸ»æ©Ÿèƒ½:**
- `assigned_by`: èª°ãŒã‚°ãƒ«ãƒ¼ãƒ—ã«è¿½åŠ ã—ãŸã‹
- `assigned_at`: ã„ã¤ã‚°ãƒ«ãƒ¼ãƒ—ã«è¿½åŠ ã•ã‚ŒãŸã‹

**å½¹å‰²:**
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã‚°ãƒ«ãƒ¼ãƒ—ã®å¤šå¯¾å¤šãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç®¡ç†
- 1ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è¤‡æ•°ã®ã‚°ãƒ«ãƒ¼ãƒ—ã«æ‰€å±å¯èƒ½

---

## ERå›³

```mermaid
erDiagram
    users ||--o{ user_role_assignments : "has direct roles"
    users ||--o{ user_group_assignments : "belongs to groups"

    roles ||--o{ user_role_assignments : "assigned to user"
    roles ||--o{ group_role_permissions : "included in group"

    group_roles ||--o{ group_role_permissions : "contains roles"
    group_roles ||--o{ user_group_assignments : "has members"

    companies ||--o{ group_roles : "owns custom groups"

    users {
        int id PK
        int company_id FK
        string name
        string email
        string password_hash
    }

    roles {
        int id PK
        string code UK "ä¾‹: user.create"
        string name "ä¾‹: ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ"
        text description
        string resource_type "ä¾‹: user"
        datetime created_at
        datetime updated_at
    }

    group_roles {
        int id PK
        string role_id
        string group_role_name "ä¾‹: ç®¡ç†è€…ã‚°ãƒ«ãƒ¼ãƒ—"
        text description
        int company_id FK "NULL=ã‚·ã‚¹ãƒ†ãƒ ã‚°ãƒ«ãƒ¼ãƒ—"
        bool is_system "default: false"
        datetime created_at
        datetime updated_at
    }

    user_role_assignments {
        int id PK
        int user_id FK
        int role_id FK
        int granted_by FK "ä»˜ä¸è€…"
        datetime created_at
        datetime updated_at
        unique user_id_role_id
    }

    group_role_permissions {
        int id PK
        int group_role_id FK
        int role_id FK
        datetime created_at
    }

    user_group_assignments {
        int id PK
        int user_id FK
        int group_role_id FK
        int assigned_by FK "å‰²ã‚Šå½“ã¦ãŸäºº"
        datetime assigned_at
        datetime created_at
        unique user_id_group_role_id
    }
```

---

## æ¨©é™ãƒã‚§ãƒƒã‚¯ãƒ•ãƒ­ãƒ¼

### SQLã‚¯ã‚¨ãƒªä¾‹

```sql
-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœ€çµ‚æ¨©é™ã‚’å–å¾—

-- 1. å€‹åˆ¥æ¨©é™ï¼ˆç›´æ¥ä»˜ä¸ï¼‰
SELECT roles.code
FROM roles
JOIN user_role_assignments ON user_role_assignments.role_id = roles.id
WHERE user_role_assignments.user_id = :user_id

UNION

-- 2. ã‚°ãƒ«ãƒ¼ãƒ—æ¨©é™ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—çµŒç”±ï¼‰
SELECT roles.code
FROM roles
JOIN group_role_permissions ON group_role_permissions.role_id = roles.id
JOIN user_group_assignments ON user_group_assignments.group_role_id = group_role_permissions.group_role_id
WHERE user_group_assignments.user_id = :user_id
```

### Pythonå®Ÿè£…ä¾‹

```python
async def get_user_permissions(db: AsyncSession, user_id: int) -> Set[str]:
    """
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœ€çµ‚æ¨©é™ã‚’å–å¾—

    Returns:
        Set[str]: æ¨©é™ã‚³ãƒ¼ãƒ‰ã®ã‚»ãƒƒãƒˆï¼ˆä¾‹: {"user.create", "report.view"}ï¼‰
    """
    # 1. å€‹åˆ¥æ¨©é™ã‚’å–å¾—
    direct_query = (
        select(Role.code)
        .join(UserRoleAssignment, UserRoleAssignment.role_id == Role.id)
        .where(UserRoleAssignment.user_id == user_id)
    )

    # 2. ã‚°ãƒ«ãƒ¼ãƒ—æ¨©é™ã‚’å–å¾—
    group_query = (
        select(Role.code)
        .join(GroupRolePermission, GroupRolePermission.role_id == Role.id)
        .join(UserGroupAssignment, UserGroupAssignment.group_role_id == GroupRolePermission.group_role_id)
        .where(UserGroupAssignment.user_id == user_id)
    )

    # 3. UNION ã§çµ±åˆ
    combined_query = direct_query.union(group_query)
    result = await db.execute(combined_query)
    permissions = result.scalars().all()

    return set(permissions)
```

### æ¨©é™ãƒã‚§ãƒƒã‚¯é–¢æ•°

```python
async def check_permission(db: AsyncSession, user_id: int, required_permission: str) -> bool:
    """
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç‰¹å®šã®æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯

    Args:
        db: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³
        user_id: ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
        required_permission: å¿…è¦ãªæ¨©é™ã‚³ãƒ¼ãƒ‰ï¼ˆä¾‹: "user.create"ï¼‰

    Returns:
        bool: æ¨©é™ãŒã‚ã‚Œã°Trueã€ãªã‘ã‚Œã°False
    """
    user_permissions = await get_user_permissions(db, user_id)
    return required_permission in user_permissions
```

---

## ä½¿ç”¨ä¾‹

### ä¾‹1: ã‚·ã‚¹ãƒ†ãƒ ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆ

```python
# Step 1: å€‹åˆ¥æ¨©é™ã‚’ä½œæˆ
roles = [
    Role(code="user.view", name="ãƒ¦ãƒ¼ã‚¶ãƒ¼é–²è¦§", resource_type="user"),
    Role(code="user.create", name="ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ", resource_type="user"),
    Role(code="user.update", name="ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°", resource_type="user"),
    Role(code="user.delete", name="ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤", resource_type="user"),
    Role(code="report.view", name="ãƒ¬ãƒãƒ¼ãƒˆé–²è¦§", resource_type="report"),
    Role(code="report.create", name="ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ", resource_type="report"),
]
db.add_all(roles)
await db.flush()

# Step 2: ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆ
admin_group = GroupRole(
    code="admin",
    name="ç®¡ç†è€…ã‚°ãƒ«ãƒ¼ãƒ—",
    description="ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ç”¨ã®ã‚°ãƒ«ãƒ¼ãƒ—",
    company_id=None,  # ã‚·ã‚¹ãƒ†ãƒ ã‚°ãƒ«ãƒ¼ãƒ—
    is_system=True
)
db.add(admin_group)
await db.flush()

# Step 3: ã‚°ãƒ«ãƒ¼ãƒ—ã«æ¨©é™ã‚’è¿½åŠ 
group_permissions = [
    GroupRolePermission(group_role_id=admin_group.id, role_id=role.id)
    for role in roles
]
db.add_all(group_permissions)
await db.commit()
```

---

### ä¾‹2: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®æ¨©é™ä»˜ä¸

#### ãƒ‘ã‚¿ãƒ¼ãƒ³A: ã‚°ãƒ«ãƒ¼ãƒ—ã«æ‰€å±ã•ã›ã‚‹

```python
# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ "admin" ã‚°ãƒ«ãƒ¼ãƒ—ã«è¿½åŠ 
assignment = UserGroupAssignment(
    user_id=user.id,
    group_role_id=admin_group.id,
    assigned_by=current_admin.id,
    assigned_at=datetime.now()
)
db.add(assignment)
await db.commit()

# çµæœ: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ admin ã‚°ãƒ«ãƒ¼ãƒ—ã®å…¨æ¨©é™ã‚’å–å¾—
# â†’ user.view, user.create, user.update, user.delete, report.view, report.create
```

#### ãƒ‘ã‚¿ãƒ¼ãƒ³B: å€‹åˆ¥æ¨©é™ã‚’ç›´æ¥ä»˜ä¸

```python
# ç‰¹å®šã®æ¨©é™ã ã‘ã‚’ç›´æ¥ä»˜ä¸
assignment = UserRoleAssignment(
    user_id=user.id,
    role_id=report_approve_role.id,
    granted_by=current_admin.id,
    granted_at=datetime.now(),
    reason="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆXå¯¾å¿œã®ãŸã‚ä¸€æ™‚çš„ã«æ‰¿èªæ¨©é™ã‚’ä»˜ä¸"
)
db.add(assignment)
await db.commit()

# çµæœ: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ report.approve æ¨©é™ã‚’ç›´æ¥å–å¾—
```

---

### ä¾‹3: ä¼æ¥­å°‚ç”¨ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆ

```python
# ä¼æ¥­å°‚ç”¨ã® "å–¶æ¥­ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼" ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆ
sales_manager_group = GroupRole(
    code="sales_manager",
    name="å–¶æ¥­ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼",
    description="å–¶æ¥­éƒ¨é–€ã®ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ç”¨ã‚°ãƒ«ãƒ¼ãƒ—",
    company_id=company.id,  # ä¼æ¥­å°‚ç”¨ã‚°ãƒ«ãƒ¼ãƒ—
    is_system=False
)
db.add(sales_manager_group)
await db.flush()

# ã‚°ãƒ«ãƒ¼ãƒ—ã«å¿…è¦ãªæ¨©é™ã‚’è¿½åŠ 
permissions_for_sales_manager = [
    "report.view",
    "report.view_all",
    "report.approve",
    "user.view",
]

for perm_code in permissions_for_sales_manager:
    role = await db.execute(select(Role).where(Role.code == perm_code))
    role = role.scalar_one()

    permission = GroupRolePermission(
        group_role_id=sales_manager_group.id,
        role_id=role.id
    )
    db.add(permission)

await db.commit()
```

---

## å®Ÿè£…ä¾‹

### FastAPI ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ã®æ¨©é™ãƒã‚§ãƒƒã‚¯

```python
from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy.ext.asyncio import AsyncSession
from app.database import get_db
from app.models.user import User
from app.auth.dependencies import get_current_user

router = APIRouter()

async def require_permission(required_permission: str):
    """
    æ¨©é™ãƒã‚§ãƒƒã‚¯ç”¨ã®Dependency

    ä½¿ã„æ–¹:
        @router.post("/users")
        async def create_user(
            current_user: User = Depends(require_permission("user.create"))
        ):
            ...
    """
    async def permission_checker(
        current_user: User = Depends(get_current_user),
        db: AsyncSession = Depends(get_db)
    ) -> User:
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©é™ã‚’å–å¾—
        user_permissions = await get_user_permissions(db, current_user.id)

        # æ¨©é™ãƒã‚§ãƒƒã‚¯
        if required_permission not in user_permissions:
            raise HTTPException(
                status_code=status.HTTP_403_FORBIDDEN,
                detail=f"æ¨©é™ãŒä¸è¶³ã—ã¦ã„ã¾ã™: {required_permission}"
            )

        return current_user

    return permission_checker


# ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¾‹
@router.post("/api/users")
async def create_user(
    user_data: UserCreate,
    current_user: User = Depends(require_permission("user.create")),
    db: AsyncSession = Depends(get_db)
):
    """
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

    å¿…è¦æ¨©é™: user.create
    """
    # current_user ã¯æ¨©é™ãƒã‚§ãƒƒã‚¯æ¸ˆã¿
    new_user = User(**user_data.dict())
    db.add(new_user)
    await db.commit()

    return {"id": new_user.id, "name": new_user.name}
```

---

## ã¾ã¨ã‚

### âœ… ã“ã®è¨­è¨ˆã®åˆ©ç‚¹

1. **æŸ”è»Ÿæ€§**: ã‚°ãƒ«ãƒ¼ãƒ—æ¨©é™ + å€‹åˆ¥æ¨©é™ã®çµ„ã¿åˆã‚ã›ãŒå¯èƒ½
2. **ç›£æŸ»æ€§**: èª°ãŒã„ã¤æ¨©é™ã‚’ä»˜ä¸ã—ãŸã‹å®Œå…¨ã«è¨˜éŒ²
3. **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**: ä¼æ¥­ã”ã¨ã®ã‚«ã‚¹ã‚¿ãƒ ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆå¯èƒ½
4. **Linuxé¢¨**: é¦´æŸ“ã¿ã®ã‚ã‚‹æ¨©é™ãƒ¢ãƒ‡ãƒ«ã§ç†è§£ã—ã‚„ã™ã„
5. **ã‚·ãƒ³ãƒ—ãƒ«**: æ˜ç¢ºãªãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã§ä¿å®ˆæ€§ãŒé«˜ã„
6. **æ‹¡å¼µæ€§**: æ–°ã—ã„æ¨©é™ã‚„ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å‹•çš„ã«è¿½åŠ å¯èƒ½

### ğŸ“Š ãƒ†ãƒ¼ãƒ–ãƒ«æ•°

- **ãƒã‚¹ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«**: 2å€‹ï¼ˆroles, group_rolesï¼‰
- **ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«**: 3å€‹ï¼ˆgroup_role_permissions, user_role_assignments, user_group_assignmentsï¼‰
- **åˆè¨ˆ**: 5ãƒ†ãƒ¼ãƒ–ãƒ«

---

**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**: ã“ã®è‰æ¡ˆã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ã€æ‰¿èªå¾Œã«å®Ÿè£…ã¸é€²ã¿ã¾ã™ã€‚
