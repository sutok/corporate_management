# æ¨©é™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  (Role & Permission)

**ä½œæˆæ—¥**: 2026-01-02
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.1.0
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: å®Ÿè£…å®Œäº†ï¼ˆUserPermissionè¿½åŠ ã€ãƒ«ãƒ¼ã‚¿ãƒ¼çµ±åˆã¯1/11ã®ã¿ï¼‰

## ğŸ“– ç›®æ¬¡

1. [æ¦‚è¦](#æ¦‚è¦)
2. [ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ](#ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ)
3. [ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«è©³ç´°](#ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«è©³ç´°)
4. [ã‚·ã‚¹ãƒ†ãƒ ãƒ­ãƒ¼ãƒ«å®šç¾©](#ã‚·ã‚¹ãƒ†ãƒ ãƒ­ãƒ¼ãƒ«å®šç¾©)
5. [æ¨©é™ä¸€è¦§](#æ¨©é™ä¸€è¦§)
6. [åˆ©ç”¨ãƒ•ãƒ­ãƒ¼](#åˆ©ç”¨ãƒ•ãƒ­ãƒ¼)
7. [å®Ÿè£…ä¾‹](#å®Ÿè£…ä¾‹)
8. [ãƒ†ã‚¹ãƒˆ](#ãƒ†ã‚¹ãƒˆ)
9. [å®Ÿè£…çŠ¶æ³](#å®Ÿè£…çŠ¶æ³)
10. [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](#ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)

---

## æ¦‚è¦

æœ¬ã‚·ã‚¹ãƒ†ãƒ ã¯ã€æŸ”è»Ÿãªãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ï¼ˆRBAC: Role-Based Access Controlï¼‰ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

### ä¸»ãªç‰¹å¾´

- **å¤šå¯¾å¤šãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è¤‡æ•°ã®ãƒ­ãƒ¼ãƒ«ã‚’æŒã¡ã€ãƒ­ãƒ¼ãƒ«ã¯è¤‡æ•°ã®æ¨©é™ã‚’æŒã¤
- **å€‹åˆ¥æ¨©é™ç®¡ç†**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç›´æ¥æ¨©é™ã‚’ä»˜ä¸å¯èƒ½ï¼ˆLinuxé¢¨ã®å€‹åˆ¥æ¨©é™ï¼‰
- **æŸ”è»Ÿãªæ¨©é™çµ„ã¿åˆã‚ã›**: ãƒ­ãƒ¼ãƒ«æ¨©é™ + å€‹åˆ¥æ¨©é™ã‚’çµ„ã¿åˆã‚ã›ãŸæ¨©é™ç®¡ç†
- **ä¼æ¥­åˆ¥ãƒ­ãƒ¼ãƒ«**: å„ä¼æ¥­ãŒç‹¬è‡ªã®ã‚«ã‚¹ã‚¿ãƒ ãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆå¯èƒ½
- **ã‚·ã‚¹ãƒ†ãƒ ãƒ­ãƒ¼ãƒ«**: å…¨ä¼æ¥­å…±é€šã®æ¨™æº–ãƒ­ãƒ¼ãƒ«
- **ãã‚ç´°ã‹ã„æ¨©é™ç®¡ç†**: ãƒªã‚½ãƒ¼ã‚¹å˜ä½ï¼ˆservice, user, reportç­‰ï¼‰ã§æ¨©é™ã‚’å®šç¾©
- **ç›£æŸ»æ©Ÿèƒ½**: ãƒ­ãƒ¼ãƒ«å‰²ã‚Šå½“ã¦ãƒ»æ¨©é™ä»˜ä¸ã®å±¥æ­´ï¼ˆèª°ãŒã€ã„ã¤å‰²ã‚Šå½“ã¦ãŸã‹ï¼‰

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     æ¨©é™ãƒã‚§ãƒƒã‚¯ãƒ•ãƒ­ãƒ¼                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. APIãƒªã‚¯ã‚¨ã‚¹ãƒˆ
   â†“
2. require_permission("service.subscribe")
   â†“
3. get_current_user() â†’ Userå–å¾—
   â†“
4. get_user_permissions(user_id)
   â†“
   â”œâ”€ å€‹åˆ¥æ¨©é™: UserPermission â†’ Permission
   â”œâ”€ ãƒ­ãƒ¼ãƒ«æ¨©é™: UserRole â†’ Role â†’ RolePermission â†’ Permission
   â””â”€ UNION â†’ çµ±åˆ
   â†“
5. æ¨©é™ã‚»ãƒƒãƒˆå–å¾—: {"service.subscribe", "user.view", ...}
   â†“
6. æ¨©é™ãƒã‚§ãƒƒã‚¯: "service.subscribe" in user_permissions?
   â†“
   â”œâ”€ YES â†’ å‡¦ç†ç¶šè¡Œ
   â””â”€ NO  â†’ 403 Forbidden
```

---

## ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ

### ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ã®é–¢ä¿‚

```
User (ãƒ¦ãƒ¼ã‚¶ãƒ¼)
  â”œâ”€ å¤šå¯¾å¤š â†’ UserRole â†’ Role
  â””â”€ å¤šå¯¾å¤š â†’ UserPermission (å€‹åˆ¥æ¨©é™)
                â†“
Role (ãƒ­ãƒ¼ãƒ«)
  â†• å¤šå¯¾å¤š
RolePermission (ãƒ­ãƒ¼ãƒ«æ¨©é™é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«)
  â†“
Permission (æ¨©é™)
  â†‘
  â””â”€ UserPermission ã‹ã‚‰ç›´æ¥å‚ç…§
```

### ERå›³

```mermaid
erDiagram
    User ||--o{ UserRole : "has"
    User ||--o{ UserPermission : "has"
    Role ||--o{ UserRole : "assigned to"
    Role ||--o{ RolePermission : "has"
    Permission ||--o{ RolePermission : "granted by"
    Permission ||--o{ UserPermission : "granted to"
    Company ||--o{ Role : "owns"

    User {
        int id PK
        int company_id FK
        string name
        string email
        string role "æ—§ã‚«ãƒ©ãƒ ï¼ˆéæ¨å¥¨ï¼‰"
    }

    Role {
        int id PK
        int company_id FK "NULL=ã‚·ã‚¹ãƒ†ãƒ ãƒ­ãƒ¼ãƒ«"
        string code "ãƒ­ãƒ¼ãƒ«ã‚³ãƒ¼ãƒ‰"
        string name "ãƒ­ãƒ¼ãƒ«å"
        text description
        bool is_system "ã‚·ã‚¹ãƒ†ãƒ ãƒ­ãƒ¼ãƒ«ãƒ•ãƒ©ã‚°"
    }

    Permission {
        int id PK
        string code "æ¨©é™ã‚³ãƒ¼ãƒ‰"
        string name "æ¨©é™å"
        text description
        string resource_type "ãƒªã‚½ãƒ¼ã‚¹ç¨®åˆ¥"
    }

    UserRole {
        int id PK
        int user_id FK
        int role_id FK
        datetime assigned_at
        int assigned_by FK
    }

    RolePermission {
        int id PK
        int role_id FK
        int permission_id FK
    }

    UserPermission {
        int id PK
        int user_id FK
        int permission_id FK
        int granted_by FK
        datetime granted_at
        text reason
    }
```

---

## ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«è©³ç´°

### 1. Permission (æ¨©é™)

**å ´æ‰€**: `backend/app/models/permission.py`

**å½¹å‰²**: å€‹åˆ¥ã®æ“ä½œæ¨©é™ã‚’å®šç¾©

| ã‚«ãƒ©ãƒ  | å‹ | èª¬æ˜ | ä¾‹ |
|--------|-----|------|-----|
| `id` | Integer | æ¨©é™ID (PK) | 1 |
| `code` | String(100) | æ¨©é™ã‚³ãƒ¼ãƒ‰ (UNIQUE) | `service.subscribe` |
| `name` | String(255) | æ¨©é™å | "ã‚µãƒ¼ãƒ“ã‚¹å¥‘ç´„" |
| `description` | Text | æ¨©é™ã®èª¬æ˜ | "ã‚µãƒ¼ãƒ“ã‚¹ã‚’å¥‘ç´„ã™ã‚‹" |
| `resource_type` | String(50) | ãƒªã‚½ãƒ¼ã‚¹ç¨®åˆ¥ | `service` |

**ç‰¹å¾´**:
- `code` ã¯ä¸€æ„ï¼ˆä¾‹: `user.create`, `report.view_all`ï¼‰
- `resource_type` ã§ãƒªã‚½ãƒ¼ã‚¹ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–

---

### 2. Role (ãƒ­ãƒ¼ãƒ«)

**å ´æ‰€**: `backend/app/models/role.py`

**å½¹å‰²**: æ¨©é™ã®ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆå½¹å‰²ï¼‰ã‚’å®šç¾©

| ã‚«ãƒ©ãƒ  | å‹ | èª¬æ˜ | ä¾‹ |
|--------|-----|------|-----|
| `id` | Integer | ãƒ­ãƒ¼ãƒ«ID (PK) | 1 |
| `company_id` | Integer | ä¼æ¥­ID (FK, NULLå¯) | `NULL` or `123` |
| `code` | String(50) | ãƒ­ãƒ¼ãƒ«ã‚³ãƒ¼ãƒ‰ | `company_admin` |
| `name` | String(255) | ãƒ­ãƒ¼ãƒ«å | "ä¼æ¥­ç®¡ç†è€…" |
| `description` | Text | ãƒ­ãƒ¼ãƒ«èª¬æ˜ | "ä¼æ¥­ã®ç®¡ç†è€…..." |
| `is_system` | Boolean | ã‚·ã‚¹ãƒ†ãƒ ãƒ­ãƒ¼ãƒ«ã‹ | `True` or `False` |

**åˆ¶ç´„**:
- `(company_id, code)` ã§ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„
- ã‚·ã‚¹ãƒ†ãƒ ãƒ­ãƒ¼ãƒ«: `is_system = True` ã‹ã¤ `company_id = NULL`
- ä¼æ¥­å°‚ç”¨ãƒ­ãƒ¼ãƒ«: `is_system = False` ã‹ã¤ `company_id` æŒ‡å®š

**2ç¨®é¡ã®ãƒ­ãƒ¼ãƒ«**:

| ç¨®é¡ | company_id | is_system | ç”¨é€” |
|------|-----------|-----------|------|
| **ã‚·ã‚¹ãƒ†ãƒ ãƒ­ãƒ¼ãƒ«** | `NULL` | `True` | å…¨ä¼æ¥­å…±é€šã®æ¨™æº–ãƒ­ãƒ¼ãƒ« |
| **ä¼æ¥­å°‚ç”¨ãƒ­ãƒ¼ãƒ«** | ä¼æ¥­ID | `False` | å„ä¼æ¥­ãŒã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½ |

---

### 3. RolePermission (ãƒ­ãƒ¼ãƒ«æ¨©é™é–¢é€£)

**å ´æ‰€**: `backend/app/models/role_permission.py`

**å½¹å‰²**: ãƒ­ãƒ¼ãƒ«ã¨æ¨©é™ã®å¤šå¯¾å¤šãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç®¡ç†

| ã‚«ãƒ©ãƒ  | å‹ | èª¬æ˜ |
|--------|-----|------|
| `id` | Integer | ID (PK) |
| `role_id` | Integer | ãƒ­ãƒ¼ãƒ«ID (FK) |
| `permission_id` | Integer | æ¨©é™ID (FK) |

**åˆ¶ç´„**:
- `(role_id, permission_id)` ã§ãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
- ãƒ­ãƒ¼ãƒ«å‰Šé™¤æ™‚ã¯ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰å‰Šé™¤
- æ¨©é™å‰Šé™¤æ™‚ã¯ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰å‰Šé™¤

---

### 4. UserPermission (ãƒ¦ãƒ¼ã‚¶ãƒ¼å€‹åˆ¥æ¨©é™)

**å ´æ‰€**: `backend/app/models/user_permission.py`

**å½¹å‰²**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®ç›´æ¥çš„ãªæ¨©é™ä»˜ä¸ã‚’ç®¡ç†ï¼ˆLinuxé¢¨ã®å€‹åˆ¥æ¨©é™ï¼‰

| ã‚«ãƒ©ãƒ  | å‹ | èª¬æ˜ |
|--------|-----|------|
| `id` | Integer | ID (PK) |
| `user_id` | Integer | ãƒ¦ãƒ¼ã‚¶ãƒ¼ID (FK) |
| `permission_id` | Integer | æ¨©é™ID (FK) |
| `granted_by` | Integer | ä»˜ä¸è€…ID (FK, NULLå¯) |
| `granted_at` | DateTime | ä»˜ä¸æ—¥æ™‚ |
| `reason` | Text | ä»˜ä¸ç†ç”±ï¼ˆä»»æ„ï¼‰ |

**åˆ¶ç´„**:
- `(user_id, permission_id)` ã§ãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
- ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤æ™‚ã¯ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰å‰Šé™¤
- æ¨©é™å‰Šé™¤æ™‚ã¯ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰å‰Šé™¤

**ç›£æŸ»æ©Ÿèƒ½**:
- `granted_at`: ã„ã¤æ¨©é™ãŒä»˜ä¸ã•ã‚ŒãŸã‹
- `granted_by`: èª°ãŒæ¨©é™ã‚’ä»˜ä¸ã—ãŸã‹ï¼ˆç®¡ç†è€…ãƒˆãƒ¬ãƒ¼ã‚¹ï¼‰
- `reason`: ä»˜ä¸ç†ç”±ï¼ˆã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹å¯¾å¿œï¼‰

**ä½¿ç”¨ä¾‹**:
- ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã«ä¸€æ™‚çš„ãªæ¨©é™ã‚’ä»˜ä¸
- ãƒ­ãƒ¼ãƒ«ã«ã¯å«ã¾ã‚Œãªã„ç‰¹æ®Šãªæ¨©é™ã®ä»˜ä¸
- å€‹åˆ¥ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã®ç®¡ç†

---

### 5. UserRole (ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ãƒ¼ãƒ«é–¢é€£)

**å ´æ‰€**: `backend/app/models/user_role.py`

**å½¹å‰²**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ãƒ­ãƒ¼ãƒ«ã®å¤šå¯¾å¤šãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç®¡ç†

| ã‚«ãƒ©ãƒ  | å‹ | èª¬æ˜ |
|--------|-----|------|
| `id` | Integer | ID (PK) |
| `user_id` | Integer | ãƒ¦ãƒ¼ã‚¶ãƒ¼ID (FK) |
| `role_id` | Integer | ãƒ­ãƒ¼ãƒ«ID (FK) |
| `assigned_at` | DateTime | å‰²ã‚Šå½“ã¦æ—¥æ™‚ |
| `assigned_by` | Integer | å‰²ã‚Šå½“ã¦å®Ÿè¡Œè€…ID (FK) |

**åˆ¶ç´„**:
- `(user_id, role_id)` ã§ãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
- ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤æ™‚ã¯ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰å‰Šé™¤
- ãƒ­ãƒ¼ãƒ«å‰Šé™¤æ™‚ã¯ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰å‰Šé™¤

**ç›£æŸ»æ©Ÿèƒ½**:
- `assigned_at`: ã„ã¤å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸã‹
- `assigned_by`: èª°ãŒå‰²ã‚Šå½“ã¦ãŸã‹ï¼ˆç®¡ç†è€…ãƒˆãƒ¬ãƒ¼ã‚¹ï¼‰

---

## ã‚·ã‚¹ãƒ†ãƒ ãƒ­ãƒ¼ãƒ«å®šç¾©

**å ´æ‰€**: `backend/scripts/seed_permissions.py`

### 1. super_admin (ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…)

- **æ¨©é™**: **ã™ã¹ã¦** (`*`)
- **èª¬æ˜**: ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®æœ€é«˜æ¨©é™è€…
- **ç”¨é€”**: ã‚·ã‚¹ãƒ†ãƒ ä¿å®ˆã€ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ç®¡ç†

### 2. company_admin (ä¼æ¥­ç®¡ç†è€…)

- **æ¨©é™æ•°**: 10å€‹
- **èª¬æ˜**: ä¼æ¥­ã®ç®¡ç†è€…
- **ä¸»ãªæ¨©é™**:
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† (view, create, update, delete)
  - ä¼æ¥­æƒ…å ±ç®¡ç† (view, update)
  - ã‚µãƒ¼ãƒ“ã‚¹å¥‘ç´„ (view, subscribe, unsubscribe)
  - å¥‘ç´„æƒ…å ± (view, history)
  - å…¨ãƒ¬ãƒãƒ¼ãƒˆé–²è¦§ (view_all)
  - ãƒ­ãƒ¼ãƒ«ç®¡ç† (view, assign)

### 3. subscription_manager (ã‚µãƒ¼ãƒ“ã‚¹ç®¡ç†è€…)

- **æ¨©é™æ•°**: 6å€‹
- **èª¬æ˜**: ã‚µãƒ¼ãƒ“ã‚¹å¥‘ç´„ã®ç®¡ç†ã‚’è¡Œã†
- **ä¸»ãªæ¨©é™**:
  - ã‚µãƒ¼ãƒ“ã‚¹ç®¡ç† (view, subscribe, unsubscribe, manage)
  - å¥‘ç´„æƒ…å ± (view, history)

### 4. report_viewer (ãƒ¬ãƒãƒ¼ãƒˆé–²è¦§è€…)

- **æ¨©é™æ•°**: 2å€‹
- **èª¬æ˜**: ãƒ¬ãƒãƒ¼ãƒˆã®é–²è¦§æ¨©é™ã‚’æŒã¤
- **ä¸»ãªæ¨©é™**:
  - ãƒ¬ãƒãƒ¼ãƒˆé–²è¦§ (view)
  - å¥‘ç´„çŠ¶æ³é–²è¦§ (subscription.view)

### 5. basic_user (ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼)

- **æ¨©é™æ•°**: 4å€‹
- **èª¬æ˜**: åŸºæœ¬çš„ãªãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™
- **ä¸»ãªæ¨©é™**:
  - ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ (create)
  - è‡ªåˆ†ã®ãƒ¬ãƒãƒ¼ãƒˆæ›´æ–° (update_own)
  - è‡ªåˆ†ã®æƒ…å ±é–²è¦§ (view_self)
  - ãƒ¬ãƒãƒ¼ãƒˆé–²è¦§ (view)

---

## æ¨©é™ä¸€è¦§

### Service ç®¡ç† (4æ¨©é™)

| ã‚³ãƒ¼ãƒ‰ | åå‰ | èª¬æ˜ |
|--------|------|------|
| `service.view` | ã‚µãƒ¼ãƒ“ã‚¹é–²è¦§ | ã‚µãƒ¼ãƒ“ã‚¹æƒ…å ±ã‚’é–²è¦§ã™ã‚‹ |
| `service.subscribe` | ã‚µãƒ¼ãƒ“ã‚¹å¥‘ç´„ | ã‚µãƒ¼ãƒ“ã‚¹ã‚’å¥‘ç´„ã™ã‚‹ |
| `service.unsubscribe` | ã‚µãƒ¼ãƒ“ã‚¹è§£ç´„ | ã‚µãƒ¼ãƒ“ã‚¹ã‚’è§£ç´„ã™ã‚‹ |
| `service.manage` | ã‚µãƒ¼ãƒ“ã‚¹ç®¡ç† | ã‚µãƒ¼ãƒ“ã‚¹è¨­å®šã‚’ç®¡ç†ã™ã‚‹ |

### Subscription ç®¡ç† (2æ¨©é™)

| ã‚³ãƒ¼ãƒ‰ | åå‰ | èª¬æ˜ |
|--------|------|------|
| `subscription.view` | å¥‘ç´„çŠ¶æ³é–²è¦§ | è‡ªç¤¾ã®å¥‘ç´„çŠ¶æ³ã‚’é–²è¦§ã™ã‚‹ |
| `subscription.history` | å¥‘ç´„å±¥æ­´é–²è¦§ | å¥‘ç´„å±¥æ­´ã‚’é–²è¦§ã™ã‚‹ |

### User ç®¡ç† (5æ¨©é™)

| ã‚³ãƒ¼ãƒ‰ | åå‰ | èª¬æ˜ |
|--------|------|------|
| `user.view` | ãƒ¦ãƒ¼ã‚¶ãƒ¼é–²è¦§ | ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’é–²è¦§ã™ã‚‹ |
| `user.create` | ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ | æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã™ã‚‹ |
| `user.update` | ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–° | ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æ›´æ–°ã™ã‚‹ |
| `user.delete` | ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã™ã‚‹ |
| `user.view_self` | è‡ªåˆ†ã®æƒ…å ±é–²è¦§ | è‡ªåˆ†ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’é–²è¦§ã™ã‚‹ |

### Company ç®¡ç† (3æ¨©é™)

| ã‚³ãƒ¼ãƒ‰ | åå‰ | èª¬æ˜ |
|--------|------|------|
| `company.view` | ä¼æ¥­æƒ…å ±é–²è¦§ | ä¼æ¥­æƒ…å ±ã‚’é–²è¦§ã™ã‚‹ |
| `company.update` | ä¼æ¥­æƒ…å ±æ›´æ–° | ä¼æ¥­æƒ…å ±ã‚’æ›´æ–°ã™ã‚‹ |
| `company.delete` | ä¼æ¥­å‰Šé™¤ | ä¼æ¥­ã‚’å‰Šé™¤ã™ã‚‹ |

### Report ç®¡ç† (5æ¨©é™)

| ã‚³ãƒ¼ãƒ‰ | åå‰ | èª¬æ˜ |
|--------|------|------|
| `report.view` | ãƒ¬ãƒãƒ¼ãƒˆé–²è¦§ | ãƒ¬ãƒãƒ¼ãƒˆã‚’é–²è¦§ã™ã‚‹ |
| `report.view_all` | å…¨ãƒ¬ãƒãƒ¼ãƒˆé–²è¦§ | å…¨ã¦ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’é–²è¦§ã™ã‚‹ |
| `report.create` | ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ | æ–°ã—ã„ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã™ã‚‹ |
| `report.update_own` | è‡ªåˆ†ã®ãƒ¬ãƒãƒ¼ãƒˆæ›´æ–° | è‡ªåˆ†ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’æ›´æ–°ã™ã‚‹ |
| `report.approve` | ãƒ¬ãƒãƒ¼ãƒˆæ‰¿èª | ãƒ¬ãƒãƒ¼ãƒˆã‚’æ‰¿èªã™ã‚‹ |

### Role ç®¡ç† (5æ¨©é™)

| ã‚³ãƒ¼ãƒ‰ | åå‰ | èª¬æ˜ |
|--------|------|------|
| `role.view` | ãƒ­ãƒ¼ãƒ«é–²è¦§ | ãƒ­ãƒ¼ãƒ«æƒ…å ±ã‚’é–²è¦§ã™ã‚‹ |
| `role.create` | ãƒ­ãƒ¼ãƒ«ä½œæˆ | æ–°ã—ã„ãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã™ã‚‹ |
| `role.update` | ãƒ­ãƒ¼ãƒ«æ›´æ–° | ãƒ­ãƒ¼ãƒ«æƒ…å ±ã‚’æ›´æ–°ã™ã‚‹ |
| `role.delete` | ãƒ­ãƒ¼ãƒ«å‰Šé™¤ | ãƒ­ãƒ¼ãƒ«ã‚’å‰Šé™¤ã™ã‚‹ |
| `role.assign` | ãƒ­ãƒ¼ãƒ«å‰²ã‚Šå½“ã¦ | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ­ãƒ¼ãƒ«ã‚’å‰²ã‚Šå½“ã¦ã‚‹ |

**åˆè¨ˆ**: 21æ¨©é™

---

## åˆ©ç”¨ãƒ•ãƒ­ãƒ¼

### 1. åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥

**å®Ÿè¡Œæ–¹æ³•**:

```bash
cd backend
.venv/bin/python scripts/seed_permissions.py
```

**å‡¦ç†å†…å®¹**:
1. 21å€‹ã®æ¨©é™ï¼ˆPermissionï¼‰ã‚’ä½œæˆ
2. 5å€‹ã®ã‚·ã‚¹ãƒ†ãƒ ãƒ­ãƒ¼ãƒ«ï¼ˆRoleï¼‰ã‚’ä½œæˆ
3. å„ãƒ­ãƒ¼ãƒ«ã«æ¨©é™ã‚’è‡ªå‹•å‰²ã‚Šå½“ã¦ï¼ˆRolePermissionï¼‰

**å®Ÿè¡Œçµæœä¾‹**:

```
=== æ¨©é™ã®ä½œæˆ ===
+ ä½œæˆ: service.view
+ ä½œæˆ: service.subscribe
+ ä½œæˆ: service.unsubscribe
...
æ¨©é™ä½œæˆå®Œäº†: 21 ä»¶

=== ã‚·ã‚¹ãƒ†ãƒ ãƒ­ãƒ¼ãƒ«ã®ä½œæˆ ===
+ ä½œæˆ: super_admin
  â†’ æ¨©é™å‰²ã‚Šå½“ã¦: 21 ä»¶
+ ä½œæˆ: company_admin
  â†’ æ¨©é™å‰²ã‚Šå½“ã¦: 10 ä»¶
...
ã‚·ã‚¹ãƒ†ãƒ ãƒ­ãƒ¼ãƒ«ä½œæˆå®Œäº†: 5 ä»¶

âœ… åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥å®Œäº†ï¼
```

---

### 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®ãƒ­ãƒ¼ãƒ«å‰²ã‚Šå½“ã¦

**æ–¹æ³•1: ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§å‰²ã‚Šå½“ã¦**

```python
from app.models.user_role import UserRole

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ­ãƒ¼ãƒ«ã‚’å‰²ã‚Šå½“ã¦
user_role = UserRole(
    user_id=user.id,
    role_id=role.id,
    assigned_by=admin_user.id,  # ç®¡ç†è€…ã®ID
)
db.add(user_role)
await db.commit()
```

**æ–¹æ³•2: è¤‡æ•°ãƒ­ãƒ¼ãƒ«å‰²ã‚Šå½“ã¦**

```python
# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¤‡æ•°ã®ãƒ­ãƒ¼ãƒ«ã‚’ä»˜ä¸
roles = ["basic_user", "report_viewer"]

for role_code in roles:
    # ãƒ­ãƒ¼ãƒ«ã‚’å–å¾—
    result = await db.execute(
        select(Role).where(
            Role.code == role_code,
            Role.company_id.is_(None)  # ã‚·ã‚¹ãƒ†ãƒ ãƒ­ãƒ¼ãƒ«
        )
    )
    role = result.scalar_one_or_none()

    if role:
        user_role = UserRole(
            user_id=user.id,
            role_id=role.id,
            assigned_by=admin_user.id
        )
        db.add(user_role)

await db.commit()
```

---

### 3. APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ã®æ¨©é™ãƒã‚§ãƒƒã‚¯

**åŸºæœ¬çš„ãªä½¿ã„æ–¹**:

```python
from fastapi import APIRouter, Depends
from sqlalchemy.ext.asyncio import AsyncSession
from app.auth.permissions import require_permission
from app.database import get_db
from app.models.user import User

router = APIRouter()

@router.post("/api/services/subscribe")
async def subscribe_service(
    service_id: int,
    current_user: User = Depends(require_permission("service.subscribe")),
    db: AsyncSession = Depends(get_db),
):
    """
    ã‚µãƒ¼ãƒ“ã‚¹å¥‘ç´„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

    æ¨©é™ãƒã‚§ãƒƒã‚¯:
    - service.subscribe æ¨©é™ãŒå¿…è¦
    - æ¨©é™ãŒãªã„å ´åˆã¯è‡ªå‹•çš„ã« 403 Forbidden ãŒè¿”ã‚‹
    """
    # current_user ã¯æ¨©é™ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼
    # ã“ã“ã«å®Ÿè£…ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ›¸ã
    ...
```

**è¤‡æ•°æ¨©é™ï¼ˆANDæ¡ä»¶ï¼‰**:

```python
@router.put("/api/users/{user_id}")
async def update_user(
    user_id: int,
    current_user: User = Depends(
        require_permission("user.update", "user.view")  # ä¸¡æ–¹å¿…è¦
    ),
    db: AsyncSession = Depends(get_db),
):
    """
    ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

    æ¨©é™ãƒã‚§ãƒƒã‚¯:
    - user.update AND user.view ã®ä¸¡æ–¹ãŒå¿…è¦
    """
    ...
```

**è¤‡æ•°æ¨©é™ï¼ˆORæ¡ä»¶ï¼‰**:

```python
from app.auth.permissions import require_any_permission

@router.get("/api/reports")
async def get_reports(
    current_user: User = Depends(
        require_any_permission("report.view", "report.view_all")  # ã„ãšã‚Œã‹
    ),
    db: AsyncSession = Depends(get_db),
):
    """
    ãƒ¬ãƒãƒ¼ãƒˆä¸€è¦§å–å¾—ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

    æ¨©é™ãƒã‚§ãƒƒã‚¯:
    - report.view OR report.view_all ã®ã„ãšã‚Œã‹ãŒã‚ã‚Œã°OK
    """
    ...
```

---

### 4. æ¨©é™å–å¾—ã®å†…éƒ¨å‹•ä½œ

**SQLå®Ÿè¡Œãƒ•ãƒ­ãƒ¼**:

```python
# app/auth/permissions.py ã® get_user_permissions()
user_permissions = await get_user_permissions(db, user_id)
# => {"service.subscribe", "user.view", "report.create", ...}
```

**å®Ÿè¡Œã•ã‚Œã‚‹SQLã‚¯ã‚¨ãƒª**:

```sql
-- å€‹åˆ¥æ¨©é™ã‚’å–å¾—
SELECT permissions.code
FROM permissions
JOIN user_permissions ON user_permissions.permission_id = permissions.id
WHERE user_permissions.user_id = :user_id

UNION

-- ãƒ­ãƒ¼ãƒ«æ¨©é™ã‚’å–å¾—
SELECT permissions.code
FROM permissions
JOIN role_permissions ON role_permissions.permission_id = permissions.id
JOIN user_roles ON user_roles.role_id = role_permissions.role_id
WHERE user_roles.user_id = :user_id
```

**å‡¦ç†ã®æµã‚Œ**:

1. **å€‹åˆ¥æ¨©é™ã®å–å¾—**:
   - `user_permissions` ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç›´æ¥æ¨©é™IDã‚’å–å¾—
   - `permissions` ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰æ¨©é™ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
2. **ãƒ­ãƒ¼ãƒ«æ¨©é™ã®å–å¾—**:
   - `user_roles` ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ãƒ¼ãƒ«IDã‚’å–å¾—
   - `role_permissions` ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ãƒ­ãƒ¼ãƒ«ã®æ¨©é™IDã‚’å–å¾—
   - `permissions` ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰æ¨©é™ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
3. **çµ±åˆ**:
   - UNION ã§å€‹åˆ¥æ¨©é™ã¨ãƒ­ãƒ¼ãƒ«æ¨©é™ã‚’çµ±åˆ
   - é‡è¤‡ã‚’é™¤ã„ã¦ã‚»ãƒƒãƒˆã¨ã—ã¦è¿”ã™

---

## å®Ÿè£…ä¾‹

### ä¾‹1: ä¼æ¥­å°‚ç”¨ã‚«ã‚¹ã‚¿ãƒ ãƒ­ãƒ¼ãƒ«ã®ä½œæˆ

```python
from app.models.role import Role
from app.models.role_permission import RolePermission
from app.models.permission import Permission
from sqlalchemy import select

async def create_custom_role(
    db: AsyncSession,
    company_id: int,
    role_code: str,
    role_name: str,
    permission_codes: list[str]
):
    """
    ä¼æ¥­å°‚ç”¨ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆ

    Args:
        db: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³
        company_id: ä¼æ¥­ID
        role_code: ãƒ­ãƒ¼ãƒ«ã‚³ãƒ¼ãƒ‰ï¼ˆä¾‹: "sales_manager"ï¼‰
        role_name: ãƒ­ãƒ¼ãƒ«åï¼ˆä¾‹: "å–¶æ¥­ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼"ï¼‰
        permission_codes: ä»˜ä¸ã™ã‚‹æ¨©é™ã‚³ãƒ¼ãƒ‰ã®ãƒªã‚¹ãƒˆ
    """
    # 1. ãƒ­ãƒ¼ãƒ«ä½œæˆ
    role = Role(
        company_id=company_id,
        code=role_code,
        name=role_name,
        description=f"{role_name}ã®æ¨©é™ã‚»ãƒƒãƒˆ",
        is_system=False,  # ä¼æ¥­å°‚ç”¨ãƒ­ãƒ¼ãƒ«
    )
    db.add(role)
    await db.flush()

    # 2. æ¨©é™ã‚’å–å¾—ã—ã¦å‰²ã‚Šå½“ã¦
    for perm_code in permission_codes:
        result = await db.execute(
            select(Permission).where(Permission.code == perm_code)
        )
        permission = result.scalar_one_or_none()

        if permission:
            role_perm = RolePermission(
                role_id=role.id,
                permission_id=permission.id
            )
            db.add(role_perm)

    await db.commit()
    await db.refresh(role)

    return role

# ä½¿ç”¨ä¾‹
sales_manager_role = await create_custom_role(
    db=db,
    company_id=company.id,
    role_code="sales_manager",
    role_name="å–¶æ¥­ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼",
    permission_codes=[
        "report.view_all",
        "report.approve",
        "user.view",
        "customer.view",
    ]
)
```

---

### ä¾‹2: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å€‹åˆ¥æ¨©é™ä»˜ä¸

```python
from app.models.user_permission import UserPermission
from app.models.permission import Permission
from sqlalchemy import select

async def grant_user_permission(
    db: AsyncSession,
    user_id: int,
    permission_code: str,
    granted_by_user_id: int,
    reason: str = None
):
    """
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å€‹åˆ¥æ¨©é™ã‚’ä»˜ä¸

    Args:
        db: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³
        user_id: ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
        permission_code: ä»˜ä¸ã™ã‚‹æ¨©é™ã‚³ãƒ¼ãƒ‰ï¼ˆä¾‹: "service.subscribe"ï¼‰
        granted_by_user_id: ä»˜ä¸ã™ã‚‹ç®¡ç†è€…ã®ID
        reason: ä»˜ä¸ç†ç”±ï¼ˆç›£æŸ»ç”¨ï¼‰
    """
    # 1. æ¨©é™ã‚’å–å¾—
    result = await db.execute(
        select(Permission).where(Permission.code == permission_code)
    )
    permission = result.scalar_one_or_none()

    if not permission:
        raise ValueError(f"æ¨©é™ '{permission_code}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")

    # 2. æ—¢ã«ä»˜ä¸ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    existing = await db.execute(
        select(UserPermission).where(
            UserPermission.user_id == user_id,
            UserPermission.permission_id == permission.id
        )
    )
    if existing.scalar_one_or_none():
        raise ValueError(f"æ¨©é™ '{permission_code}' ã¯æ—¢ã«ä»˜ä¸ã•ã‚Œã¦ã„ã¾ã™")

    # 3. å€‹åˆ¥æ¨©é™ã‚’ä»˜ä¸
    user_perm = UserPermission(
        user_id=user_id,
        permission_id=permission.id,
        granted_by=granted_by_user_id,
        reason=reason
    )
    db.add(user_perm)
    await db.commit()
    await db.refresh(user_perm)

    return user_perm

# ä½¿ç”¨ä¾‹
await grant_user_permission(
    db=db,
    user_id=123,
    permission_code="report.approve",
    granted_by_user_id=admin_user.id,
    reason="ä¸€æ™‚çš„ã«ãƒ¬ãƒãƒ¼ãƒˆæ‰¿èªæ¨©é™ã‚’ä»˜ä¸ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆXå¯¾å¿œï¼‰"
)
```

---

### ä¾‹3: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©é™ç¢ºèª

```python
from app.auth.permissions import get_user_permissions, get_user_permissions_detailed

# ã‚·ãƒ³ãƒ—ãƒ«ãªæ¨©é™ã‚³ãƒ¼ãƒ‰ã‚»ãƒƒãƒˆå–å¾—
permissions = await get_user_permissions(db, user.id)
print(permissions)
# => {"service.subscribe", "user.view", "report.create"}

# è©³ç´°æƒ…å ±ä»˜ãæ¨©é™å–å¾—
detailed = await get_user_permissions_detailed(db, user.id)
print(detailed)
# => {
#   "user_id": 123,
#   "permissions": [
#     {
#       "code": "service.subscribe",
#       "name": "ã‚µãƒ¼ãƒ“ã‚¹å¥‘ç´„",
#       "description": "ã‚µãƒ¼ãƒ“ã‚¹ã‚’å¥‘ç´„ã™ã‚‹",
#       "resource_type": "service",
#       "source": "direct",  # å€‹åˆ¥æ¨©é™
#       "granted_by": "å±±ç”°å¤ªéƒ",
#       "granted_at": "2026-01-02T10:30:00+09:00",
#       "reason": "ä¸€æ™‚çš„ãªæ¨©é™ä»˜ä¸"
#     },
#     {
#       "code": "report.view",
#       "name": "ãƒ¬ãƒãƒ¼ãƒˆé–²è¦§",
#       "description": "ãƒ¬ãƒãƒ¼ãƒˆã‚’é–²è¦§ã™ã‚‹",
#       "resource_type": "report",
#       "source": "role",  # ãƒ­ãƒ¼ãƒ«æ¨©é™
#       "via_roles": ["basic_user", "report_viewer"]
#     },
#     ...
#   ]
# }
```

---

### ä¾‹4: subscriptions.pyã®å®Ÿè£…ï¼ˆå‚è€ƒå®Ÿè£…ï¼‰

**å ´æ‰€**: `backend/app/routers/subscriptions.py`

```python
from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy.ext.asyncio import AsyncSession
from app.auth.permissions import require_permission
from app.database import get_db
from app.models.user import User

router = APIRouter(prefix="/api/subscriptions", tags=["subscriptions"])

@router.get("/history")
async def get_subscription_history(
    subscription_id: Optional[int] = None,
    current_user: User = Depends(require_permission("subscription.history")),
    db: AsyncSession = Depends(get_db),
):
    """
    å¥‘ç´„å±¥æ­´å–å¾—

    å¿…è¦æ¨©é™: subscription.history
    """
    # company_idã§ç›´æ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    query = select(ServiceSubscriptionHistory).where(
        ServiceSubscriptionHistory.company_id == current_user.company_id
    )

    if subscription_id:
        query = query.where(
            ServiceSubscriptionHistory.subscription_id == subscription_id
        )

    query = query.order_by(ServiceSubscriptionHistory.changed_at.desc())

    result = await db.execute(query)
    history_records = result.scalars().all()

    return [
        {
            "id": record.id,
            "company_id": record.company_id,
            "subscription_id": record.subscription_id,
            "change_type": record.change_type,
            # ... ãã®ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
        }
        for record in history_records
    ]
```

---

## ãƒ†ã‚¹ãƒˆ

### ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«

**å ´æ‰€**: `backend/tests/test_permissions.py`

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä¸€è¦§

1. `test_create_permission` - Permissionä½œæˆãƒ†ã‚¹ãƒˆ
2. `test_create_role` - ä¼æ¥­å°‚ç”¨Roleä½œæˆãƒ†ã‚¹ãƒˆ
3. `test_create_system_role` - ã‚·ã‚¹ãƒ†ãƒ Roleä½œæˆãƒ†ã‚¹ãƒˆ
4. `test_role_permission_assignment` - ãƒ­ãƒ¼ãƒ«ã¸ã®æ¨©é™å‰²ã‚Šå½“ã¦ãƒ†ã‚¹ãƒˆ
5. `test_user_role_assignment` - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®ãƒ­ãƒ¼ãƒ«å‰²ã‚Šå½“ã¦ãƒ†ã‚¹ãƒˆ
6. `test_get_user_permissions` - ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™å–å¾—ãƒ†ã‚¹ãƒˆï¼ˆãƒ­ãƒ¼ãƒ«æ¨©é™ï¼‰
7. `test_user_multiple_roles` - è¤‡æ•°ãƒ­ãƒ¼ãƒ«å‰²ã‚Šå½“ã¦ãƒ†ã‚¹ãƒˆ
8. `test_create_user_permission` - å€‹åˆ¥æ¨©é™ä½œæˆãƒ†ã‚¹ãƒˆ
9. `test_user_permission_with_role_permission` - å€‹åˆ¥æ¨©é™+ãƒ­ãƒ¼ãƒ«æ¨©é™ã®çµ±åˆãƒ†ã‚¹ãƒˆ
10. `test_get_user_permissions_detailed_with_direct_permissions` - è©³ç´°æ¨©é™æƒ…å ±å–å¾—ãƒ†ã‚¹ãƒˆ
11. `test_direct_permission_overrides_role_in_detailed_view` - è©³ç´°ãƒ“ãƒ¥ãƒ¼ã§ã®æ¨©é™è¡¨ç¤ºå„ªå…ˆåº¦ãƒ†ã‚¹ãƒˆ

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

```bash
cd backend
.venv/bin/pytest tests/test_permissions.py -v
```

**å®Ÿè¡Œçµæœä¾‹**:

```
tests/test_permissions.py::test_create_permission PASSED                 [  9%]
tests/test_permissions.py::test_create_role PASSED                       [ 18%]
tests/test_permissions.py::test_create_system_role PASSED                [ 27%]
tests/test_permissions.py::test_role_permission_assignment PASSED        [ 36%]
tests/test_permissions.py::test_user_role_assignment PASSED              [ 45%]
tests/test_permissions.py::test_get_user_permissions PASSED              [ 54%]
tests/test_permissions.py::test_user_multiple_roles PASSED               [ 63%]
tests/test_permissions.py::test_create_user_permission PASSED            [ 72%]
tests/test_permissions.py::test_user_permission_with_role_permission PASSED [ 81%]
tests/test_permissions.py::test_get_user_permissions_detailed_with_direct_permissions PASSED [ 90%]
tests/test_permissions.py::test_direct_permission_overrides_role_in_detailed_view PASSED [100%]

============================== 11 passed in 8.63s ==============================
```

---

## å®Ÿè£…çŠ¶æ³

### âœ… å®Œäº†æ¸ˆã¿

- **ãƒ¢ãƒ‡ãƒ«å®Ÿè£…**: Permission, Role, RolePermission, UserRole, UserPermission
- **æ¨©é™ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½**: `app/auth/permissions.py`
  - `require_permission()`: ç‰¹å®šã®æ¨©é™ã‚’è¦æ±‚
  - `require_any_permission()`: ã„ãšã‚Œã‹ã®æ¨©é™ãŒã‚ã‚Œã°OK
  - `get_user_permissions()`: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©é™å–å¾—ï¼ˆå€‹åˆ¥æ¨©é™+ãƒ­ãƒ¼ãƒ«æ¨©é™ã®UNIONï¼‰
  - `get_user_permissions_detailed()`: è©³ç´°æ¨©é™æƒ…å ±å–å¾—ï¼ˆsourceè¡¨ç¤ºä»˜ãï¼‰
  - `check_permissions()`: æ¨©é™ãƒã‚§ãƒƒã‚¯
- **å€‹åˆ¥æ¨©é™ç®¡ç†**: `app/models/user_permission.py`
  - Linuxé¢¨ã®å€‹åˆ¥æ¨©é™ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…
  - ç›£æŸ»æ©Ÿèƒ½ï¼ˆgranted_by, granted_at, reasonï¼‰
- **åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥**: `scripts/seed_permissions.py`
- **ãƒ†ã‚¹ãƒˆ**: `tests/test_permissions.py` (11ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹)
- **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**: Permission, Role, UserPermission ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ

### âš ï¸ æœªå®Œäº†ï¼ˆé«˜å„ªå…ˆåº¦ï¼‰

**é€²æ—**: 1/9 ãƒ«ãƒ¼ã‚¿ãƒ¼ (11.1%)

**é©ç”¨æ¸ˆã¿**:
- âœ… `subscriptions.py` - ã‚µãƒ¼ãƒ“ã‚¹å¥‘ç´„ç®¡ç†

**æœªé©ç”¨** (æ®‹ã‚Š8ãƒ«ãƒ¼ã‚¿ãƒ¼):
1. âŒ `auth.py` - èªè¨¼é–¢é€£
2. âŒ `branches.py` - æ”¯åº—ç®¡ç†
3. âŒ `companies.py` - ä¼æ¥­ç®¡ç†
4. âŒ `customers.py` - é¡§å®¢ç®¡ç†
5. âŒ `daily_reports.py` - æ—¥å ±ç®¡ç†
6. âŒ `departments.py` - éƒ¨ç½²ç®¡ç†
7. âŒ `users.py` - ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
8. âŒ ãã®ä»–ãƒ«ãƒ¼ã‚¿ãƒ¼

**ã‚¿ã‚¹ã‚¯è©³ç´°**: `TODO.md` ã®ã€Œã‚¿ã‚¹ã‚¯ #1: æ—¢å­˜ãƒ«ãƒ¼ã‚¿ãƒ¼ã¸ã®æ¨©é™ãƒã‚§ãƒƒã‚¯é©ç”¨ã€

**æ¨å®šå·¥æ•°**: 4-6æ™‚é–“

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### Q1: æ¨©é™ãƒã‚§ãƒƒã‚¯ã§å¸¸ã«403ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹

**åŸå› **:
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ­ãƒ¼ãƒ«ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ãªã„
- ãƒ­ãƒ¼ãƒ«ã«å¿…è¦ãªæ¨©é™ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ãªã„

**ç¢ºèªæ–¹æ³•**:

```python
# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©é™ã‚’ç¢ºèª
from app.auth.permissions import get_user_permissions_detailed

permissions = await get_user_permissions_detailed(db, user.id)
print(permissions)
```

**è§£æ±ºç­–**:

```python
# ãƒ­ãƒ¼ãƒ«ã‚’å‰²ã‚Šå½“ã¦
user_role = UserRole(
    user_id=user.id,
    role_id=basic_user_role.id,  # basic_user ãƒ­ãƒ¼ãƒ«
)
db.add(user_role)
await db.commit()
```

---

### Q2: åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå¤±æ•—ã™ã‚‹

**ã‚¨ãƒ©ãƒ¼ä¾‹**:
```
sqlalchemy.exc.OperationalError: could not connect to server
```

**åŸå› **: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šè¨­å®šãŒé–“é•ã£ã¦ã„ã‚‹

**è§£æ±ºç­–**:

```bash
# .env ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
cat backend/.env

# æ­£ã—ã„æ¥ç¶šæƒ…å ±ã‚’è¨­å®š
DATABASE_URL=postgresql://attendance_user:attendance_password@localhost:5432/attendance_db
DATABASE_URL_ASYNC=postgresql+asyncpg://attendance_user:attendance_password@localhost:5432/attendance_db
```

---

### Q3: ã‚·ã‚¹ãƒ†ãƒ ãƒ­ãƒ¼ãƒ«ã¨ä¼æ¥­å°‚ç”¨ãƒ­ãƒ¼ãƒ«ã®é•ã„ã¯?

| é …ç›® | ã‚·ã‚¹ãƒ†ãƒ ãƒ­ãƒ¼ãƒ« | ä¼æ¥­å°‚ç”¨ãƒ­ãƒ¼ãƒ« |
|------|---------------|---------------|
| `company_id` | `NULL` | ä¼æ¥­ID |
| `is_system` | `True` | `False` |
| ä½œæˆæ–¹æ³• | `seed_permissions.py` | API/ç®¡ç†ç”»é¢ |
| å‰Šé™¤å¯èƒ½? | âŒ ä¸å¯ | âœ… å¯èƒ½ |
| ç”¨é€” | æ¨™æº–ãƒ­ãƒ¼ãƒ«ï¼ˆå…¨ä¼æ¥­å…±é€šï¼‰ | ã‚«ã‚¹ã‚¿ãƒ ãƒ­ãƒ¼ãƒ«ï¼ˆä¼æ¥­ç‹¬è‡ªï¼‰ |

---

### Q4: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¤‡æ•°ã®ãƒ­ãƒ¼ãƒ«ã‚’æŒãŸã›ã‚‹æ„å‘³ã¯?

**ãƒ¡ãƒªãƒƒãƒˆ**:
1. **æŸ”è»Ÿãªæ¨©é™ç®¡ç†**: è¤‡æ•°ã®å½¹å‰²ã‚’å…¼ä»»ã§ãã‚‹
2. **æ¨©é™ã®çµ„ã¿åˆã‚ã›**: `basic_user` + `report_viewer` ãªã©
3. **æ®µéšçš„ãªæ¨©é™ä»˜ä¸**: å¿…è¦ã«å¿œã˜ã¦ãƒ­ãƒ¼ãƒ«ã‚’è¿½åŠ 

**ä¾‹**:
```python
# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¤‡æ•°ãƒ­ãƒ¼ãƒ«ã‚’ä»˜ä¸
user_roles = [
    UserRole(user_id=user.id, role_id=basic_user_role.id),
    UserRole(user_id=user.id, role_id=report_viewer_role.id),
    UserRole(user_id=user.id, role_id=subscription_manager_role.id),
]
db.add_all(user_roles)
await db.commit()

# çµæœ: 3ã¤ã®ãƒ­ãƒ¼ãƒ«ã®æ¨©é™ã‚’å…¨ã¦æŒã¤
```

---

### Q5: æ¨©é™è¿½åŠ ã®æ¨å¥¨æ‰‹é †ã¯?

1. **æ¨©é™ã‚’å®šç¾©** (`seed_permissions.py` ã«è¿½åŠ )
2. **åˆæœŸãƒ‡ãƒ¼ã‚¿å†æŠ•å…¥** (`python scripts/seed_permissions.py`)
3. **ãƒ­ãƒ¼ãƒ«ã«æ¨©é™ã‚’å‰²ã‚Šå½“ã¦** (å¿…è¦ã«å¿œã˜ã¦)
4. **APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«é©ç”¨** (`require_permission()`)
5. **ãƒ†ã‚¹ãƒˆä½œæˆ** (æ¨©é™ãƒã‚§ãƒƒã‚¯ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹)

---

## å‚è€ƒãƒªãƒ³ã‚¯

### é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- **ãƒ¢ãƒ‡ãƒ«**: `backend/app/models/permission.py`, `role.py`, `role_permission.py`, `user_role.py`, `user_permission.py`
- **æ¨©é™ãƒã‚§ãƒƒã‚¯**: `backend/app/auth/permissions.py`
- **åˆæœŸãƒ‡ãƒ¼ã‚¿**: `backend/scripts/seed_permissions.py`
- **ãƒ†ã‚¹ãƒˆ**: `backend/tests/test_permissions.py`
- **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**: `backend/alembic/versions/a1b2c3d4e5f6_add_user_permission_table.py`
- **å®Ÿè£…ä¾‹**: `backend/app/routers/subscriptions.py`
- **TODO**: `TODO.md` (ã‚¿ã‚¹ã‚¯ #1)

### ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- **å…¨ä½“è¨­è¨ˆ**: `claudedocs/CLAUDE.md`
- **APIè¨­è¨ˆæ›¸**: `claudedocs/APIè¨­è¨ˆæ›¸.md`
- **TODO**: `TODO.md`

---

**æœ€çµ‚æ›´æ–°**: 2026-01-02 (UserPermissionæ©Ÿèƒ½è¿½åŠ )
**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**: æ®‹ã‚Š10ãƒ«ãƒ¼ã‚¿ãƒ¼ã¸ã®æ¨©é™ãƒã‚§ãƒƒã‚¯é©ç”¨ï¼ˆé«˜å„ªå…ˆåº¦ï¼‰
